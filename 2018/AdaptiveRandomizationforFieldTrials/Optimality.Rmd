---
title: "Optimality Criteria for Covariance"
author: "Peter Claussen"
output: html_document
---

```{r}
options(digits=12)
trace <- function(x) {sum(diag(x))}
library(ggplot2)
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#0072B2", "#D55E00", "#F0E442","#CC79A7","#000000","#734f80", "#2b5a74", "#004f39", "#787221", "#003959", "#6aaf00", "#663cd3")
```

# Analysis of Covariance

Following Milliken (), we model the standard randomized complete block model as


$$
y_{ij} = \alpha_i + b_j + e_{ij}
$$

and extend this to the analysis of covariance with an equal-slope model
$$
y_{ij} = \alpha_i + b_j + \beta x_{ij} + e_{ij}
$$

and a treatment-covariate interaction model

$$
y_{ij} = \alpha_i + b_j + \beta x_{ij} + \beta_i x_{ij} + e_{ij}
$$
We will also compare with a simple regression and regression and interaction models

## Table 9.1, Milliken III


```{r}
arm.dat <- data.frame(
plot=as.factor(c(102, 201, 302, 401, 502, 601, 101, 202, 301, 402, 501, 602)), 
treatment=as.factor(c(1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2)), 
replicate=as.factor(c(1, 2, 3, 4, 5, 6, 1, 2, 3, 4, 5, 6)),
assessment2=c(26.60, 31.10, 34.70, 34.40, 32.10, 28.50, 30.20, 29.20, 32.10, 31.90, 30.20, 31.00), 
assessment1=c(0.91, 1.22, 1.43, 1.45, 1.33, 1.10, 1.02, 0.89, 1.39, 1.47, 1.27, 1.12)
)
arm.lm <- lm(assessment2 ~ replicate + assessment1 + treatment, data=arm.dat, model=FALSE)
alt.lm <- lm(assessment2 ~ treatment + assessment1 + replicate, data=arm.dat, model=FALSE,x=TRUE)
aov.tbl<-anova(arm.lm)
alt.tbl<-anova(alt.lm)
print(summary(arm.lm))
print(aov.tbl)
print(alt.tbl)

treatments <- length(levels(arm.dat$treatment))
C.t <- match.fun(arm.lm$contrasts[['treatment']])(treatments)
reps <- length(levels(arm.dat$replicate))
L.r <- matrix(rep(1,(reps-1)*treatments),nrow=treatments)
L.r <- L.r/(reps)
coeffs <- arm.lm$coefficients

cov.means <- rep(mean(arm.dat$assessment1),dim(C.t)[1])
L  <- cbind(rep(1,dim(C.t)[1]), cov.means, L.r, C.t)
trt.means <- L %*% coeffs
means.tbl <- data.frame(trt=as.integer(levels(arm.dat$treatment)),arith=tapply(arm.dat$assessment2, list(arm.dat$treatment), mean),lsmean= trt.means)
means.tbl
L.contrasts <- NULL
for(i in 1:  (dim(L)[1]-1)) {
  for(j in (i+1):(dim(L)[1])) {
    L.contrasts <- rbind(L.contrasts, L[i,]-L[j,])
  }
}
L.contrasts

Vcoeffs <- vcov(arm.lm)
Vcoeffs
Sigma.m <- 1 / sqrt(diag(L.contrasts %*% Vcoeffs %*% t(L.contrasts)))
if(dim(L.contrasts)[1]>1) {
  Sigma <- diag(Sigma.m)
} else {
  Sigma <- Sigma.m
}
Sigma.m
t_ <- Sigma %*% L.contrasts %*% coeffs
Cor <- Sigma %*% (L.contrasts %*% Vcoeffs %*% t(L.contrasts)) %*% t(Sigma)
se.vec <- diag(L.contrasts %*% Vcoeffs %*% t(L.contrasts))
SE.table <- matrix(0,nrow=treatments,ncol=treatments)

se.idx <- 1
for (i in 1:(dim(L)[1]-1)) {
   for(j in (i+1):(dim(L)[1])) {
      SE.table[i,j] <- se.vec[se.idx]
      SE.table[j,i] <- se.vec[se.idx]
      se.idx <- se.idx + 1
   }
}
SE.table
X <- alt.lm$x
(t(X) %*% X)

alpha = 0.05
err.df <- arm.lm$df.residual
crit.t <-qtukey(1 - alpha / 2, treatments, err.df)
crit.tbl <- SE.table * crit.t
crit.tbl
```


```{r,fig.height=5,fig.width=5}
qplot(treatment,assessment1,data=arm.dat,geom='boxplot') +   
  stat_summary(fun.y=mean,shape=1,col='red',geom='point') + 
  labs(y= "OC", x = "Treatment") +
  ggtitle("RCB Blocks")
```

```{r,fig.height=5,fig.width=8}
ggplot(arm.dat, aes(replicate,assessment1)) + 
geom_point(aes(colour = treatment),size=2) + 
scale_colour_manual(values=cbPalette) +
  labs(colour = "Treatment", x="Replicate", y="OC", title = "Replicate Covariates")
```

```{r}
ggplot(arm.dat, aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(colour = "Treatment", x="OC", y="Yield", title = "Replicate Covariates")
```

```{r}
ggplot(arm.dat, aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(x="OC", y="Yield", title = "Replicate Covariates")
```

# Comparisons

We need to normalize the covariate

```{r}
arm.dat$cov <- arm.dat$assessment1/(max(arm.dat$assessment1))
```

## Models

- Simple Regression
- Independent Intercept
- Independent Slope
- Replicate
- Replicate Interaction

```{r}
rcb.lm <- lm(assessment1 ~ replicate + treatment, data = arm.dat, model=FALSE, x = TRUE)
Model1.lm <- lm(assessment1 ~ cov, data = arm.dat, model=FALSE, x = TRUE)
Model2.lm <- lm(assessment1 ~ cov +  treatment, data = arm.dat, model=FALSE, x = TRUE)
Model3.lm <- lm(assessment1 ~ cov +  treatment + treatment:cov, data = arm.dat, model=FALSE, x = TRUE)
Model4.lm <- lm(assessment1 ~ cov +  treatment + replicate + treatment:cov, data = arm.dat, model=FALSE, x = TRUE)
Model5.lm <- lm(assessment1 ~ cov +  treatment + replicate + treatment:cov + replicate:cov, data = arm.dat, model=FALSE, x = TRUE)
```

## Information

- Design information

$$
\mathcal{I} = X^{t} X
$$

```{r}
print(I.rcb <- t(rcb.lm$x) %*% rcb.lm$x)
print(I.1 <- t(Model1.lm$x) %*% Model1.lm$x)
print(I.2 <- t(Model2.lm$x) %*% Model2.lm$x)
print(I.3 <- t(Model3.lm$x) %*% Model3.lm$x)
print(I.4 <- t(Model4.lm$x) %*% Model4.lm$x)
print(I.5 <- t(Model5.lm$x) %*% Model5.lm$x)

print(Ds <- c(det(I.1), det(I.2), det(I.3), det(I.4), det(I.5)))
print(As <- c(trace(I.1), trace(I.2), trace(I.3), trace(I.4), trace(I.5)))
```

- Contrast information

$$
c^{t} \mathcal{I}^{-} c
$$

since $Var(\widehat{ {c^{t} \tau}} ) = c^{t} \mathcal{I}^{-} c \sigma^2$

```{r}
treatments <- length(levels(arm.dat$treatment))
C.t.rcb <- match.fun(rcb.lm$contrasts[['treatment']])(treatments)
reps <- length(levels(arm.dat$replicate))
L.r.rcb <- matrix(rep(1,(reps-1)*treatments),nrow=treatments)
L.r.rcb <- L.r.rcb/(reps)
```

```{r}
midpoint <- mean(arm.dat$cov) #(max(arm.dat$cov) + min(arm.dat$cov))/2
cov.means <-rep(midpoint,dim(C.t.rcb)[1]) # rep(mean(arm.dat$assessment1),dim(C.t.rcb)[1])
L.rcb  <- cbind(rep(1,dim(C.t.rcb)[1]), L.r.rcb, C.t.rcb)
#L.rcbc  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means, C.t.rcb, L.r.rcb)

L.1  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means)
L.2  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means, C.t.rcb)
L.3  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means, C.t.rcb, C.t.rcb*mean(arm.dat$cov))
L.4  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means, C.t.rcb, L.r.rcb, C.t.rcb*mean(arm.dat$cov))
L.5  <- cbind(rep(1,dim(C.t.rcb)[1]), cov.means, C.t.rcb, L.r.rcb, C.t.rcb*mean(arm.dat$cov), L.r.rcb*mean(arm.dat$cov))
```


```{r}
Table9.1.means <- data.frame(
  RCB = L.rcb %*% coef(rcb.lm),
  M1 = L.1 %*% coef(Model1.lm),
  M2 = L.2 %*% coef(Model2.lm),
  M3 = L.3 %*% coef(Model3.lm),
  M4 = L.4 %*% coef(Model4.lm),
  M5 = L.5 %*% coef(Model5.lm)
)
Table9.1.means
```

```{r}
library(lsmeans)

lsmeans(rcb.lm, ~ treatment)
#lsmeans(Model1.lm, ~ treatment)
lsmeans(Model2.lm, ~ treatment)
lsmeans(Model3.lm, ~ treatment)
lsmeans(Model4.lm, ~ treatment)
lsmeans(Model5.lm, ~ treatment)
```

```{r}
L.rcb.contrasts <- NULL
L.1.contrasts <- NULL
L.2.contrasts <- NULL
L.3.contrasts <- NULL
L.4.contrasts <- NULL
L.5.contrasts <- NULL
for(i in 1:  (dim(L.rcb)[1]-1)) {
  for(j in (i+1):(dim(L.rcb)[1])) {
    L.rcb.contrasts <- rbind(L.rcb.contrasts, L.rcb[i,]-L.rcb[j,])
    L.1.contrasts <- rbind(L.1.contrasts, L.1[i,]-L.1[j,])
    L.2.contrasts <- rbind(L.2.contrasts, L.2[i,]-L.2[j,])
    L.3.contrasts <- rbind(L.3.contrasts, L.3[i,]-L.3[j,])
    L.4.contrasts <- rbind(L.4.contrasts, L.4[i,]-L.4[j,])
    L.5.contrasts <- rbind(L.5.contrasts, L.5[i,]-L.5[j,])
  }
}
L.rcb.contrasts[1,]
L.1.contrasts[1,]
L.2.contrasts[1,]
L.3.contrasts[1,]
L.4.contrasts[1,]
L.5.contrasts[1,]
```


```{r}
print(CI.rcb <- L.rcb.contrasts %*% I.rcb %*% t(L.rcb.contrasts))
print(CI.1 <- L.1.contrasts %*% I.1 %*% t(L.1.contrasts))
print(CI.2 <- L.2.contrasts %*% I.2 %*% t(L.2.contrasts))
print(CI.3 <- L.3.contrasts %*% I.3 %*% t(L.3.contrasts))
print(CI.4 <- L.4.contrasts %*% I.4 %*% t(L.4.contrasts))
print(CI.5 <- L.5.contrasts %*% I.5 %*% t(L.5.contrasts))

print(DCs <- c(det(CI.rcb), det(CI.1), det(CI.2), det(CI.3), det(CI.4), det(CI.5)))
print(ACs <- c(trace(CI.rcb), trace(CI.1), trace(CI.2), trace(CI.3), trace(CI.4), trace(CI.5)))
```


# Covariate Blocking

```{r,fig.height=12,fig.width=8}
OCRank <- rank(tapply(arm.dat$assessment1,list(arm.dat$replicate),mean))
arm.dat$OCRank <- OCRank[arm.dat$replicate]
arm.dat$OCRank <- as.factor(arm.dat$OCRank)
```

```{r}
p<-qplot(OCRank,assessment1,data=arm.dat,geom='boxplot')
p<-p+stat_summary(fun.y=mean,shape=1,col='red',geom='point')
print(p)
```

```{r}
arm.dat$Rank <- rank(arm.dat$cov,ties.method = c("random"))
arm.dat$PostBlock <- ceiling(arm.dat$Rank/2)
for(blk in 1:max(arm.dat$PostBlock)) {
  arm.dat$PostTreatment[arm.dat$PostBlock==blk] <- sample(1:2)
}
arm.dat$PostBlock <- as.factor(arm.dat$PostBlock)
arm.dat$PostTreatment <- as.factor(arm.dat$PostTreatment)
arm.dat
aggregate(assessment1 ~ treatment,arm.dat,mean)
aggregate(assessment1 ~ treatment,arm.dat,sd)
aggregate(assessment1 ~ PostTreatment,arm.dat,mean)
aggregate(assessment1 ~ PostTreatment,arm.dat,sd)
```

```{r}
library(ggplot2)
qplot(PostBlock,assessment1,data=arm.dat,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point')
```

```{r,fig.height=5,fig.width=5}
qplot(PostTreatment,assessment1,data=arm.dat,geom='boxplot') +   
  stat_summary(fun.y=mean,shape=1,col='red',geom='point') + 
  labs(y= "OC", x = "Treatment") +
  ggtitle("RCB Blocks")
```


```{r}

PostModel1.lm <- lm(assessment1 ~ cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel2.lm <- lm(assessment1 ~ cov +  PostTreatment, data = arm.dat, model=FALSE, x = TRUE)
PostModel3.lm <- lm(assessment1 ~ cov +  PostTreatment + PostTreatment:cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel4.lm <- lm(assessment1 ~ cov +  PostTreatment + PostBlock + PostTreatment:cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel5.lm <- lm(assessment1 ~ cov +  PostTreatment + PostBlock + PostTreatment:cov + PostBlock:cov, data = arm.dat, model=FALSE, x = TRUE)

print(I.P1 <- t(PostModel1.lm$x) %*% PostModel1.lm$x)
print(I.P2 <- t(PostModel2.lm$x) %*% PostModel2.lm$x)
print(I.P3 <- t(PostModel3.lm$x) %*% PostModel3.lm$x)
print(I.P4 <- t(PostModel4.lm$x) %*% PostModel4.lm$x)
print(I.P5 <- t(PostModel5.lm$x) %*% PostModel5.lm$x)
```

```{r}
L.P1.contrasts <- NULL
L.P2.contrasts <- NULL
L.P3.contrasts <- NULL
L.P4.contrasts <- NULL

for(i in 1:  (dim(L.rcb)[1]-1)) {
  for(j in (i+1):(dim(L.rcb)[1])) {
    L.P1.contrasts <- rbind(L.P1.contrasts, L.1[i,]-L.1[j,])
    L.P2.contrasts <- rbind(L.P2.contrasts, L.2[i,]-L.2[j,])
    L.P3.contrasts <- rbind(L.P3.contrasts, L.3[i,]-L.3[j,])
    L.P4.contrasts <- rbind(L.P4.contrasts, L.4[i,]-L.4[j,])
  }
}
```


```{r}
print(CI.P1 <- L.P1.contrasts %*% I.P1 %*% t(L.P1.contrasts))
print(CI.P2 <- L.P2.contrasts %*% I.P2 %*% t(L.P2.contrasts))
print(CI.P3 <- L.P3.contrasts %*% I.P3 %*% t(L.P3.contrasts))
print(CI.P4 <- L.P4.contrasts %*% I.P4 %*% t(L.P4.contrasts))

print(Post.DCs <- c(det(CI.rcb), det(CI.P1), det(CI.P2), det(CI.P3), det(CI.P4)))
print(Post.ACs <- c(trace(CI.rcb), trace(CI.P1), trace(CI.P2), trace(CI.P3), trace(CI.P4)))
```

# Optimal Designs

Assume our analysis is based on solving 
$$
\hat{\beta} = (F^T F)^{-1} F^T y
$$

with

$$
var(\hat{\beta}) = \sigma^2 (F^T F)^{-1}
$$

where $F$ is the design matrix for the experiment.

D-optimal design maximizes $| F^T F |$, since this minimizes $\sigma^2 (F^T F)^{-1}$

A-optimal are less stringent - they minimize the average variance, or $trace((F^T F)^{-1})$

```{r}
ggplot(arm.dat, aes(OCRank,assessment1)) + 
geom_point(aes(colour = treatment),size=2) + 
scale_colour_manual(values=cbPalette)
ggplot(arm.dat, aes(PostBlock,assessment1)) + 
geom_point(aes(colour = treatment),size=2) + 
scale_colour_manual(values=cbPalette)
```

# Simulations

## Cochran data
```{r}
cochran.arm.dat <- data.frame(
plot=as.factor(c(301, 603, 702, 1101, 304, 601, 902, 1203, 103, 604, 904, 1103, 101, 404, 804, 1201, 204, 402, 903, 1102, 202, 502, 704, 1003, 303, 401, 801, 1004, 203, 503, 701, 1202, 104, 501, 803, 1104, 102, 403, 703, 1204, 302, 504, 802, 1001, 201, 602, 901, 1002)), 
treatment=as.factor(c(1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 4, 4, 4, 4, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11, 11, 11, 12, 12, 12, 12)), 
replicate=as.factor(c(1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 3, 4)), 
block=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
column=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
y=c(3.00, 3.00, 4.00, 5.00, 3.00, 3.00, 6.00, 6.00, 1.00, 3.00, 6.00, 5.00, 1.00, 1.00, 5.00, 6.00, 2.00, 1.00, 6.00, 5.00, 2.00, 2.00, 4.00, 4.00, 3.00, 1.00, 5.00, 4.00, 2.00, 2.00, 4.00, 6.00, 1.00, 2.00, 5.00, 5.00, 1.00, 1.00, 4.00, 6.00, 3.00, 2.00, 5.00, 4.00, 2.00, 3.00, 6.00, 4.00), 
x=c(1.00, 7.00, 2.00, 5.00, 4.00, 5.00, 2.00, 7.00, 3.00, 8.00, 4.00, 7.00, 1.00, 8.00, 4.00, 5.00, 4.00, 6.00, 3.00, 6.00, 2.00, 6.00, 4.00, 7.00, 3.00, 5.00, 1.00, 8.00, 3.00, 7.00, 1.00, 6.00, 4.00, 5.00, 3.00, 8.00, 2.00, 7.00, 3.00, 8.00, 2.00, 8.00, 2.00, 5.00, 1.00, 6.00, 1.00, 6.00), 
lat=c(17.00, 17.00, 24.00, 31.00, 17.00, 17.00, 38.00, 38.00, 3.00, 17.00, 38.00, 31.00, 3.00, 3.00, 31.00, 38.00, 10.00, 3.00, 38.00, 31.00, 10.00, 10.00, 24.00, 24.00, 17.00, 3.00, 31.00, 24.00, 10.00, 10.00, 24.00, 38.00, 3.00, 10.00, 31.00, 31.00, 3.00, 3.00, 24.00, 38.00, 17.00, 10.00,
31.00, 24.00, 10.00, 17.00, 38.00, 24.00), 
lon=c(2.00, 29.00, 6.50, 20.00, 15.50, 20.00, 6.50, 29.00, 11.00, 33.50, 15.50, 29.00, 2.00, 33.50, 15.50, 20.00, 15.50, 24.50, 11.00, 24.50, 6.50, 24.50, 15.50, 29.00, 11.00, 20.00, 2.00, 33.50, 11.00, 29.00, 2.00, 24.50, 15.50, 20.00, 11.00, 33.50, 6.50, 29.00, 11.00, 33.50, 6.50, 33.50,
6.50, 20.00, 2.00, 24.50, 2.00, 24.50), 
assessment2=c(268.00, 132.00, 256.00, 236.00, 408.00, 292.00, 280.00, 142.00, 415.00, 454.00, 386.00, 176.00, 365.00, 298.00, 379.00, 199.00, 222.00, 114.00, 398.00, 332.00, 561.00, 92.00, 304.00, 308.00, 433.00, 80.00, 194.00, 221.00, 311.00, 28.00, 372.00, 166.00, 338.00, 254.00, 421.00, 137.00, 563.00,
268.00, 708.00, 590.00, 505.00, 106.00, 219.00, 356.00, 363.00, 352.00, 466.00, 212.00), 
assessment1=c(124.00, 109.00, 230.00, 107.00, 222.00, 193.00, 283.00, 80.00, 107.00, 153.00, 212.00, 41.00, 162.00, 48.00, 263.00, 95.00, 42.00, 19.00, 252.00, 89.00, 193.00, 9.00, 145.00, 42.00, 194.00, 23.00, 138.00, 62.00, 128.00, 17.00, 282.00, 127.00, 67.00, 29.00, 197.00, 74.00, 191.00, 44.00,
216.00, 134.00, 211.00, 19.00, 100.00, 88.00, 102.00, 209.00, 269.00, 25.00)
)
```

```{r,fig.height=6,fig.width=6}
CovMeans <- tapply(cochran.arm.dat$assessment1,list(cochran.arm.dat$treatment),mean)
CovOrder <-  order(CovMeans)
qplot(treatment,assessment1,data=cochran.arm.dat,geom='boxplot') + 
  stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  scale_x_discrete(limits=names(CovMeans)[CovOrder])
```

```{r,fig.height=6,fig.width=6}
CovSD <- tapply(cochran.arm.dat$assessment1,list(cochran.arm.dat$treatment),sd)
CovOrder <-  order(CovSD)
qplot(treatment,assessment1,data=cochran.arm.dat,geom='boxplot') + 
  stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  scale_x_discrete(limits=names(CovMeans)[CovOrder])
```

```{r,fig.height=6,fig.width=8}
ggplot(cochran.arm.dat, aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(colour = "Treatment", x="Covariate", y="Response", title = "Covariate Regression")
```

```{r}
extremes <- levels(cochran.arm.dat$treatment)[c(which.min(CovMeans), which.max(CovMeans))]

ggplot(cochran.arm.dat[cochran.arm.dat$treatment %in% extremes,], aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(x="OC", y="Yield", title = "Extremes, Cochran")
```

```{r}
extremes <- levels(cochran.arm.dat$treatment)[c(which.min(CovSD), which.max(CovSD))]

ggplot(cochran.arm.dat[cochran.arm.dat$treatment %in% extremes,], aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(x="OC", y="Yield", title = "Extremes, Cochran")
```

## Milliken 10.2

```{r}
milliken10.2.arm.dat <- data.frame(
plot=as.factor(c(101, 202, 303, 404, 501, 605, 703, 804, 902, 1004, 1105, 1203, 105, 201, 305, 401, 505, 603, 701, 803, 905, 1002, 1104, 1201, 104, 203, 304, 405, 502, 604, 705, 801, 903, 1001, 1103, 1202, 102, 205, 302, 403, 504, 602, 704, 802, 901, 1003, 1102, 1205, 103, 204, 301, 402, 503, 601, 702, 805, 904, 1005, 1101, 1204)), 
treatment=as.factor(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5)), 
replicate=as.factor(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)), 
block=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
column=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
y=c(1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 10.00, 11.00, 12.00, 1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 10.00, 11.00, 12.00, 1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 10.00, 11.00, 12.00, 1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00,
9.00, 10.00, 11.00, 12.00, 1.00, 2.00, 3.00, 4.00, 5.00, 6.00, 7.00, 8.00, 9.00, 10.00, 11.00, 12.00), 
x=c(1.00, 2.00, 3.00, 4.00, 1.00, 5.00, 3.00, 4.00, 2.00, 4.00, 5.00, 3.00, 5.00, 1.00, 5.00, 1.00, 5.00, 3.00, 1.00, 3.00, 5.00, 2.00, 4.00, 1.00, 4.00, 3.00, 4.00, 5.00, 2.00, 4.00, 5.00, 1.00, 3.00, 1.00, 3.00, 2.00, 2.00, 5.00, 2.00, 3.00, 4.00, 2.00, 4.00, 2.00, 1.00,
3.00, 2.00, 5.00, 3.00, 4.00, 1.00, 2.00, 3.00, 1.00, 2.00, 5.00, 4.00, 5.00, 1.00, 4.00), 
lat=c(3.00, 10.00, 17.00, 24.00, 31.00, 38.00, 45.00, 52.00, 59.00, 66.00, 73.00, 80.00, 3.00, 10.00, 17.00, 24.00, 31.00, 38.00, 45.00, 52.00, 59.00, 66.00, 73.00, 80.00, 3.00, 10.00, 17.00, 24.00, 31.00, 38.00, 45.00, 52.00, 59.00, 66.00, 73.00, 80.00, 3.00, 10.00, 17.00, 24.00, 31.00,
38.00, 45.00, 52.00, 59.00, 66.00, 73.00, 80.00, 3.00, 10.00, 17.00, 24.00, 31.00, 38.00, 45.00, 52.00, 59.00, 66.00, 73.00, 80.00), 
lon=c(2.00, 6.50, 11.00, 15.50, 2.00, 20.00, 11.00, 15.50, 6.50, 15.50, 20.00, 11.00, 20.00, 2.00, 20.00, 2.00, 20.00, 11.00, 2.00, 11.00, 20.00, 6.50, 15.50, 2.00, 15.50, 11.00, 15.50, 20.00, 6.50, 15.50, 20.00, 2.00, 11.00, 2.00, 11.00, 6.50, 6.50, 20.00, 6.50, 11.00, 15.50, 6.50,
15.50, 6.50, 2.00, 11.00, 6.50, 20.00, 11.00, 15.50, 2.00, 6.50, 11.00, 2.00, 6.50, 20.00, 15.50, 20.00, 2.00, 15.50), 
assessment2=c(55.10, 50.70, 58.40, 60.50, 60.60, 60.40, 62.10, 59.50, 68.10, 66.70, 68.70, 64.90, 59.60, 59.10, 65.50, 57.90, 65.60, 64.80, 64.70, 64.00, 64.90, 75.90, 68.50, 63.60, 63.50, 65.70, 66.10, 72.70, 70.60, 62.40, 66.00, 76.10, 80.50, 82.80, 75.30, 75.50, 66.10, 59.90, 77.80, 73.50,
91.10, 69.70, 76.20, 78.30, 79.80, 84.00, 87.80, 80.20, 80.50, 78.60, 76.40, 78.70, 82.20, 67.00, 86.80, 81.20, 96.40, 79.00, 76.10, 88.50), 
assessment1=c(14.00, 15.40, 13.50, 19.00, 12.00, 24.10, 28.90, 18.70, 25.60, 22.70, 25.30, 22.60, 11.40, 20.60, 21.20, 9.00, 16.90, 21.30, 23.60, 16.00, 13.20, 28.50, 14.80, 11.10, 14.40, 20.30, 15.60, 20.80, 16.50, 14.20, 17.80, 24.80, 27.20, 28.50, 19.20, 18.40, 12.20, 11.90, 21.60, 17.00,
31.40, 16.20, 22.90, 19.10, 19.40, 22.40, 26.10, 19.80, 21.10, 24.30, 16.10, 17.50, 19.00, 12.50, 26.90, 19.80, 28.60, 16.70, 14.90, 22.40)
)
```


```{r,fig.height=6,fig.width=6}
CovRank <- rank(tapply(milliken10.2.arm.dat$assessment1,list(milliken10.2.arm.dat$treatment),mean))
milliken10.2.arm.dat$CovRank <- CovRank[milliken10.2.arm.dat$treatment]
milliken10.2.arm.dat$CovRank <- as.factor(milliken10.2.arm.dat$CovRank)
p<-qplot(CovRank,assessment1,data=milliken10.2.arm.dat,geom='boxplot')
p<-p+stat_summary(fun.y=mean,shape=1,col='red',geom='point')
print(p)
```

```{r,fig.height=6,fig.width=8}
ggplot(milliken10.2.arm.dat, aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
  geom_smooth(se = FALSE, method = lm,color='black',size=2) +
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm,size=1) +
scale_colour_manual(values=cbPalette) +
  labs(colour = "Treatment", x="Covariate", y="Response", title = "Covariate Regression")
```

```{r}
print(treatment.sd <- tapply(milliken10.2.arm.dat$assessment1, list(milliken10.2.arm.dat$treatment),sd))

extremes <- levels(milliken10.2.arm.dat$treatment)[c(which.min(treatment.sd), which.max(treatment.sd))]

ggplot(milliken10.2.arm.dat[milliken10.2.arm.dat$treatment %in% extremes,], aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(x="Covariate", y="Response", title = "Extremes, Milliken")
```

# Kuehl Ex 17.3
```{r}
kuehl17.3.arm.dat <- data.frame(
treatment=as.factor(c(1,1,1,1,2,2,2,2,3,3,3,3)), 
replicate=as.factor(c(1,2,3,4,1,2,3,4,1,2,3,4)), 
assessment2=c(1.5,3.1,3.8,3.3,1.9,1.8,2.9,2.3,1.1,4.3,3.7,1.8), 
assessment1=c(45,58,61,59,54,57,55,56,43,60,71,48)
)
```


```{r,fig.height=6,fig.width=6}
CovRank <- rank(tapply(kuehl17.3.arm.dat$assessment1,list(kuehl17.3.arm.dat$treatment),mean),ties.method = c("random"))
kuehl17.3.arm.dat$CovRank <- CovRank[kuehl17.3.arm.dat$treatment]
kuehl17.3.arm.dat$CovRank <- as.factor(kuehl17.3.arm.dat$CovRank)
p<-qplot(CovRank,assessment1,data=kuehl17.3.arm.dat,geom='boxplot')
p<-p+stat_summary(fun.y=mean,shape=1,col='red',geom='point')
print(p)
```

```{r,fig.height=6,fig.width=8}
ggplot(kuehl17.3.arm.dat, aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(colour = "Treatment", x="Covariate", y="Response", title = "Covariate Regression")
```

```{r}
print(treatment.sd <- tapply(kuehl17.3.arm.dat$assessment1, list(kuehl17.3.arm.dat$treatment),sd))

extremes <- levels(kuehl17.3.arm.dat$treatment)[c(which.min(treatment.sd), which.max(treatment.sd))]

ggplot(kuehl17.3.arm.dat[kuehl17.3.arm.dat$treatment %in% extremes,], aes(assessment1,assessment2)) + 
geom_point(aes(colour = treatment),size=2) + 
geom_smooth(aes(group=treatment,color=treatment),se = FALSE, method = lm) +
scale_colour_manual(values=cbPalette) +
  labs(x="Covariate", y="Response", title = "Extremes, Milliken")
```

# 100 RCB randomizations

# 100 Postblock randomizations

### Blocking Example
```{r}
blocking.arm.dat <- data.frame(
plot=as.factor(c(108, 210, 311, 407, 509, 604, 710, 806, 105, 209, 308, 406, 502, 606, 705, 804, 106, 205, 301, 403, 508, 610, 706, 801, 102, 204, 305, 404, 510, 601, 704, 805, 103, 206, 309, 402, 506, 605, 701, 803, 111, 202, 303, 409, 504, 608, 703, 811, 104, 201, 304, 411, 503, 607, 702, 808, 109, 211, 307, 405, 501, 603, 708, 802, 101, 203, 302, 410, 505, 609, 707, 810, 107, 208, 310, 401, 507, 611, 709, 807, 110, 207, 306, 408, 511, 602, 711, 809)), 
treatment=as.factor(c(1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11)), 
replicate=as.factor(c(1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6, 7, 8)), 
block=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
column=as.factor(c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)), 
assessment2=c(7.000000, 2.000000, 4.000000, 4.000000, 3.000000, 7.000000, 3.000000, 1.000000, 9.000000, 5.000000, 6.000000, 6.000000, 3.000000, 9.000000, 3.000000, 5.000000, 4.000000, 5.000000, 4.000000, 6.000000, 5.000000, 6.000000, 8.000000, 9.000000, 5.000000, 0.000000, 9.000000, 3.000000, 2.000000, 9.000000, 1.000000, 3.000000, 3.000000, 3.000000, 3.000000, 9.000000, 2.000000, 3.000000, 6.000000, 2.000000, 2.000000, 5.000000, 6.000000, 4.000000,
7.000000, 3.000000, 3.000000, 1.000000, 7.000000, 3.000000, 3.000000, 8.000000, 4.000000, 5.000000, 2.000000, 3.000000, 9.000000, 6.000000, 2.000000, 0.000000, 0.000000, 1.000000, 4.000000, 4.000000, 2.000000, 8.000000, 8.000000, 1.000000, 9.000000, 9.000000, 0.000000, 4.000000, 2.000000, 2.000000, 9.000000, 1.000000, 9.000000, 4.000000, 6.000000, 4.000000, 5.000000, 4.000000, 1.000000, 2.000000, 8.000000, 4.000000, 5.000000, 5.000000), 
assessment1=c(23.000000, 5.000000, 7.000000, 30.000000, 17.000000, 24.000000, 18.000000, 24.000000, 52.000000, 12.000000, 41.000000, 13.000000, 72.000000, 19.000000, 114.000000, 78.000000, 37.000000, 56.000000, 44.000000, 28.000000, 13.000000, 22.000000, 2.000000, 43.000000, 35.000000, 64.000000, 20.000000, 29.000000, 19.000000, 25.000000, 44.000000, 11.000000, 45.000000, 15.000000, 17.000000, 67.000000, 7.000000, 24.000000, 17.000000, 23.000000,
10.000000, 142.000000, 72.000000, 10.000000, 25.000000, 56.000000, 25.000000, 29.000000, 47.000000, 78.000000, 80.000000, 50.000000, 41.000000, 15.000000, 20.000000, 20.000000, 31.000000, 14.000000, 42.000000, 107.000000, 14.000000, 29.000000, 12.000000, 23.000000, 56.000000, 30.000000, 87.000000, 11.000000, 17.000000, 12.000000, 2.000000, 30.000000, 7.000000, 37.000000, 8.000000, 41.000000, 20.000000, 74.000000, 9.000000, 17.000000, 20.000000, 20.000000,
21.000000, 37.000000, 44.000000, 49.000000, 16.000000, 21.000000)
)
```

```{r}
#arm.dat <- blocking.arm.dat
#arm.dat <- milliken10.2.arm.dat
arm.dat <- cochran.arm.dat
#arm.dat <- kuehl17.3.arm.dat
arm.dat$cov <- arm.dat$assessment1/max(arm.dat$assessment1)
```

```{r}
simulations <- 2000
rcb.designs <- vector("list", length = simulations)
rcbrand.dat <- data.frame(
  Design = rep(0,simulations),
  MaxMeanDif = rep(0,simulations),
  MaxSDDif = rep(0,simulations),
  MeanSD = rep(0,simulations),
  D1 = rep(0,simulations),
  D2 = rep(0,simulations),
  D3 = rep(0,simulations),
  D4 = rep(0,simulations),
  D5 = rep(0,simulations),
  A1 = rep(0,simulations),
  A2 = rep(0,simulations),
  A3 = rep(0,simulations),
  A4 = rep(0,simulations)
)

postrand.dat <- rcbrand.dat
post.designs <- rcb.designs

reps <- length(levels(arm.dat$replicate))
treatments <- length(levels(arm.dat$treatment))
for (s in 1:simulations) {
  if(s!=1) {
    #rerandomize RCB treatments
    for(blk in levels(arm.dat$replicate)) {
      arm.dat$treatment[arm.dat$replicate==blk] <- levels(arm.dat$treatment)[sample(1:treatments)]
    }
  }

  arm.dat$treatment <- as.factor(arm.dat$treatment)
  rcb.designs[[s]] <- arm.dat
  #mean and standard deviation for covariate among treatments
  cov.means <- tapply(arm.dat$cov,list(arm.dat$treatment),mean)
  cov.sds <- tapply(arm.dat$cov,list(arm.dat$treatment),sd)

  rcbrand.dat$MaxMeanDif[s] <- max(cov.means)-min(cov.means)
  rcbrand.dat$MaxSDDif[s] <- max(cov.sds)-min(cov.sds)
  rcbrand.dat$MeanSD[s] <- mean(cov.sds)
  
  #fit linear models
rcb.lm <- lm(assessment1 ~ replicate + treatment, data = arm.dat, model=FALSE, x = TRUE)
Model1.lm <- lm(assessment1 ~ cov, data = arm.dat, model=FALSE, x = TRUE)
Model2.lm <- lm(assessment1 ~ cov +  treatment, data = arm.dat, model=FALSE, x = TRUE)
Model3.lm <- lm(assessment1 ~ cov +  treatment + treatment:cov, data = arm.dat, model=FALSE, x = TRUE)
Model4.lm <- lm(assessment1 ~ cov +  treatment + replicate + treatment:cov, data = arm.dat, model=FALSE, x = TRUE)
Model5.lm <- lm(assessment1 ~ cov +  treatment + replicate + treatment:cov + replicate:cov, data = arm.dat, model=FALSE, x = TRUE)

I.1 <- t(Model1.lm$x) %*% Model1.lm$x
I.2 <- t(Model2.lm$x) %*% Model2.lm$x
I.3 <- t(Model3.lm$x) %*% Model3.lm$x
I.4 <- t(Model4.lm$x) %*% Model4.lm$x
I.5 <- t(Model5.lm$x) %*% Model5.lm$x
  # randomize by covariate
  arm.dat$Rank <- rank(arm.dat$cov,ties.method = c("random"))
  #if(s!=1) {
    arm.dat$PostBlock <- ceiling(arm.dat$Rank/treatments)
    for(blk in 1:max(arm.dat$PostBlock)) {
      arm.dat$PostTreatment[arm.dat$PostBlock==blk] <- sample(1:treatments)
    }
  #} else {
  #  arm.dat$PostBlock <- arm.dat$replicate
  #}
  
  arm.dat$PostBlock <- as.factor(arm.dat$PostBlock)
  arm.dat$PostTreatment <- as.factor(arm.dat$PostTreatment)
  post.designs[[s]] <- arm.dat
  cov.means <- tapply(arm.dat$cov,list(arm.dat$PostTreatment),mean)
  cov.sds <- tapply(arm.dat$cov,list(arm.dat$PostTreatment),sd)
  
  postrand.dat$MaxMeanDif[s] <- max(cov.means)-min(cov.means)
  postrand.dat$MaxSDDif[s] <- max(cov.sds)-min(cov.sds)
  postrand.dat$MeanSD[s] <- mean(cov.sds)
  
PostModel1.lm <- lm(assessment1 ~ cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel2.lm <- lm(assessment1 ~ cov +  PostTreatment, data = arm.dat, model=FALSE, x = TRUE)
PostModel3.lm <- lm(assessment1 ~ cov +  PostTreatment + PostTreatment:cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel4.lm <- lm(assessment1 ~ cov +  PostTreatment + PostBlock + PostTreatment:cov, data = arm.dat, model=FALSE, x = TRUE)
PostModel5.lm <- lm(assessment1 ~ cov +  PostTreatment + PostBlock + PostTreatment:cov + PostBlock:cov, data = arm.dat, model=FALSE, x = TRUE)

I.P1 <- t(PostModel1.lm$x) %*% PostModel1.lm$x
I.P2 <- t(PostModel2.lm$x) %*% PostModel2.lm$x
I.P3 <- t(PostModel3.lm$x) %*% PostModel3.lm$x
I.P4 <- t(PostModel4.lm$x) %*% PostModel4.lm$x
I.P5 <- t(PostModel5.lm$x) %*% PostModel5.lm$x
  #calculate optimality from information
  rcbrand.dat$D1[s] = det(I.1)
  rcbrand.dat$D2[s]= det(I.2)
  rcbrand.dat$D3[s] = det(I.3)
  rcbrand.dat$D4[s] = det(I.4)
  rcbrand.dat$D5[s] = det(I.5)
  
  postrand.dat$D1[s] = det(I.P1)
  postrand.dat$D2[s]= det(I.P2)
  postrand.dat$D3[s] = det(I.P3)
  postrand.dat$D4[s] = det(I.P4)
  postrand.dat$D5[s] = det(I.P5)

  rcbrand.dat$A1[s] = trace(I.1)
  rcbrand.dat$A2[s]= trace(I.2)
  rcbrand.dat$A3[s] = trace(I.3)
  rcbrand.dat$A4[s] = trace(I.4)
  
  postrand.dat$A1[s] = trace(I.1)
  postrand.dat$A2[s]= trace(I.2)
  postrand.dat$A3[s] = trace(I.3)
  postrand.dat$A4[s] = trace(I.4)

  

}
```



# Relationship among optimality measures

```{r}
rcbrand.dat$Source <- 'RCB'
postrand.dat$Source <- 'Post'
combined.dat <- rbind(rcbrand.dat,postrand.dat)
```

```{r}
ggplot(combined.dat, aes(D1, D2)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)
```

```{r}
ggplot(combined.dat, aes(D2, D3)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)
```

```{r}
ggplot(combined.dat, aes(D3, D4)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)
```

```{r}
ggplot(combined.dat, aes(D4, D5)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)
```


```{r}
ggplot(combined.dat, aes(A3, A4)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)
```


So, it appears that we can select from optimal designs using D with either model 3 or 4

```{r}
opt.designs<- c(1,
                #which.max(rcbrand.dat$D1)[1],
                #which.max(rcbrand.dat$D2)[1],
                which.max(rcbrand.dat$D3)[1],
                which.max(rcbrand.dat$D4)[1],
                which.max(rcbrand.dat$D5)[1],
                #which.max(rcbrand.dat$A1)[1],
                #which.max(rcbrand.dat$A2)[1],
                #which.max(rcbrand.dat$A3)[1],
                #which.max(rcbrand.dat$A4)[1],
                which.min(rcbrand.dat$MaxMeanDif*rcbrand.dat$MaxSDDif),
                which.min(rcbrand.dat$MaxMeanDif*rcbrand.dat$MeanSD))
opt.post.designs <- c(#which.max(postrand.dat$D1)[1],
                #which.max(postrand.dat$D2)[1],
                which.max(postrand.dat$D3)[1],
                which.max(postrand.dat$D4)[1],
                which.max(postrand.dat$D5)[1],
                #which.max(postrand.dat$A1)[1],
                #which.max(postrand.dat$A2)[1],
                #which.max(postrand.dat$A3)[1],
                #which.max(postrand.dat$A4)[1],
                which.min(postrand.dat$MaxMeanDif*postrand.dat$MaxSDDif),
                which.min(postrand.dat$MaxMeanDif*postrand.dat$MeanSD))
sub.designs <- c(#which.min(rcbrand.dat$D1)[1],
                #which.min(rcbrand.dat$D2)[1],
                which.min(rcbrand.dat$D3)[1],
                which.min(rcbrand.dat$D4)[1],
                which.min(rcbrand.dat$D5)[1],
                #which.min(rcbrand.dat$A1)[1],
                #which.min(rcbrand.dat$A2)[1],
                #which.min(rcbrand.dat$A3)[1],
                #which.min(rcbrand.dat$A4)[1],
                which.max(rcbrand.dat$MaxMeanDif*rcbrand.dat$MaxSDDif),
                which.max(rcbrand.dat$MaxMeanDif*rcbrand.dat$MeanSD))
sub.post.designs <- c(#which.min(postrand.dat$D1)[1],
                #which.min(postrand.dat$D2)[1],
                which.min(postrand.dat$D3)[1],
                which.min(postrand.dat$D4)[1],
                which.min(postrand.dat$D5)[1],
                #which.min(postrand.dat$A1)[1],
                #which.min(postrand.dat$A2)[1],
                #which.min(postrand.dat$A3)[1],
                #which.min(postrand.dat$A4)[1],
                which.max(postrand.dat$MaxMeanDif*postrand.dat$MaxSDDif),
                which.max(postrand.dat$MaxMeanDif*postrand.dat$MeanSD))
opt.d.rcb <- opt.designs[2]
opt.d.post <- opt.post.designs[1]
worst.d.rcb <- sub.designs[1]
worst.d.post <- sub.post.designs[1]

opt.designs
sub.designs 
opt.post.designs
sub.post.designs
```

```{r}
reference.rcb.dat <- subset(rcbrand.dat[opt.designs,])
reference.rcb.dat$Criteria <- c("Original",
                              "D3",
                              "D4",
                              "D5",
                              #"D",
                              #"A",
                              #"A",
                              #"A",
                              #"A",
                             "MaxxMax",
                             "MaxxMean")
reference.post.dat <- subset(postrand.dat[opt.post.designs,])
reference.post.dat$Criteria <- reference.rcb.dat$Criteria[-1]
reference.dat <- rbind(reference.rcb.dat,reference.post.dat)
```

```{r}
best.post <- post.designs[[opt.d.post]]
CovRank <- rank(tapply(best.post$cov,list(best.post$PostTreatment),mean),ties.method = c("random"))
best.post$CovRank <- CovRank[best.post$PostTreatment]
best.post$CovRank <- as.factor(best.post$CovRank)


worst.post <- post.designs[[worst.d.post]]
CovRank <- rank(tapply(worst.post$cov,list(worst.post$PostTreatment),mean),ties.method = c("random"))
worst.post$CovRank <- CovRank[worst.post$PostTreatment]
worst.post$CovRank <- as.factor(worst.post$CovRank)

best.post$Design <- 'Best Post'
worst.post$Design <- 'Worst Post'

comp.post <- rbind(best.post,worst.post)

qplot(CovRank,cov,data=comp.post,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  facet_wrap(~Design)

```


best.rcb <- rcb.designs[[opt.d.rcb]]
CovRank <- rank(tapply(best.rcb$cov,list(best.rcb$treatment),mean),ties.method = c("random"))
best.rcb$CovRank <- CovRank[best.rcb$treatment]
best.rcb$CovRank <- as.factor(best.rcb$CovRank)

best.uni <- rcb.designs[[best.d.uni]]
CovRank <- rank(tapply(best.uni$cov,list(best.uni$treatment),mean),ties.method = c("random"))
best.uni$CovRank <- CovRank[best.uni$treatment]
best.uni$CovRank <- as.factor(best.uni$CovRank)

worst.rcb <- rcb.designs[[worst.d.rcb]]
CovRank <- rank(tapply(worst.rcb$cov,list(worst.rcb$treatment),mean),ties.method = c("random"))
worst.rcb$CovRank <- CovRank[worst.rcb$treatment]
worst.rcb$CovRank <- as.factor(worst.rcb$CovRank)

best.rcb$Design <- 'Best RCB'
worst.rcb$Design <- 'Worst RCB'
best.uni$Design <- 'Best Uni'

comp.rcb <- rbind(best.rcb,worst.rcb,best.uni)

qplot(CovRank,cov,data=comp.rcb,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  facet_wrap(~Design)

comp.rcb <- rbind(best.post,worst.post,best.rcb,worst.rcb)

qplot(CovRank,cov,data=comp.rcb,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  facet_wrap(~Design)

comp.rcb <- rbind(best.post,best.rcb)

qplot(CovRank,cov,data=comp.rcb,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  facet_wrap(~Design)

comp.rcb <- rbind(worst.post,worst.rcb)

qplot(CovRank,cov,data=comp.rcb,geom='boxplot') + stat_summary(fun.y=mean,shape=1,col='red',geom='point') +
  facet_wrap(~Design)




```{r}
current.design <- 3
opt.a.design <- 5
opt.c.design <- 8
opt.b.design <- 10
opt.d.design <- 4
```


```{r}
ggplot(combined.dat, aes(x=MaxMeanDif, y=MaxSDDif)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette) +
      geom_point(data = reference.dat, mapping = aes(x=MaxMeanDif, y=MaxSDDif, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(x=MeanSD,y=MaxSDDif)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)  +
      geom_point(data = reference.dat, mapping = aes(x=MeanSD, y=MaxSDDif, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(x=MaxMeanDif, y=MeanSD)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette) +
    geom_point(data = reference.dat, mapping = aes(x=MaxMeanDif, y=MeanSD, shape=Criteria, color=Criteria), size = 4)
```



```{r}
ggplot(combined.dat, aes(x=MaxMeanDif, y=D3)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette) +
      geom_point(data = reference.dat, mapping = aes(x=MaxMeanDif, y=D3, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(x=MaxSDDif, y=D3)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)  +
      geom_point(data = reference.dat, mapping = aes(x=MaxSDDif, y=D3, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(MaxMeanDif, D4)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette) +
      geom_point(data = reference.dat, mapping = aes(x=MaxMeanDif, y=D4, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(MaxSDDif, D4)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)  +
      geom_point(data = reference.dat, mapping = aes(x=MaxSDDif, y=D4, shape=Criteria, color=Criteria), size = 4)
```


```{r}
ggplot(combined.dat, aes(MaxMeanDif, D5)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette) +
      geom_point(data = reference.dat, mapping = aes(x=MaxMeanDif, y=D5, shape=Criteria, color=Criteria), size = 4)
```

```{r}
ggplot(combined.dat, aes(MaxSDDif, D5)) + geom_point(aes(colour = Source),size=1) + scale_colour_manual(values=cbPalette)  +
      geom_point(data = reference.dat, mapping = aes(x=MaxSDDif, y=D5, shape=Criteria, color=Criteria), size = 4)
```



