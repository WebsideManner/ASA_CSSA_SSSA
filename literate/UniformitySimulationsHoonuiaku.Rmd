---
title: "Uniformity Simulations"
author: "Peter Claussen"
date: "May 18, 2016"
output: html_document
---


Multiple Trial Simulations
--------------------------

```{r}
currentwd <- getwd()
setwd("~/Work/git/ASA_CSSA_SSSA/ASA_CSSA_SSSA/R")
source("pair.distances.R")
source("plot.distance.R")
source("superimpose.plan.R")
source("simulate.plan.R")
source("trial.dimensions.R")
setwd(currentwd)

arm.plot.dim <- c(4,6)
arm.row.buffer <- c(0.5,1)
checks <- 1:4
unreplicated <- 5:12
```

```{r}
library(ggplot2)
```

Assume we have yield (or other agronomic assessment) data in spatial format, such as yield monitor data.
For example, this data from the SDSU research statio near Beresford. This file has been edited from the original format and is comma-seperated.

```{r}
raw.dat <- read.csv("./data/sdsu/Swest_Corn2013-Clean.csv", header = TRUE)

response <- "YldVolDry"
hist(raw.dat[,response],main=response)

minLon <- min(raw.dat$Longitude)
maxLon <- max(raw.dat$Longitude)
minLat <- min(raw.dat$Latitude)
maxLat <- max(raw.dat$Latitude)

northBorder <- maxLat - 0.06*(maxLat-minLat)
southBorder <- minLat + 0.09*(maxLat-minLat)
eastBorder <- maxLon - 0.02*(maxLon-minLon)
westBorder <- minLon + 0.02*(maxLon-minLon)

trimmed.dat <- subset(raw.dat,raw.dat$Latitude>=southBorder)
trimmed.dat <- subset(trimmed.dat,trimmed.dat$Latitude<=northBorder)
trimmed.dat <- subset(trimmed.dat,trimmed.dat$Longitude<=eastBorder)
trimmed.dat <- subset(trimmed.dat,trimmed.dat$Longitude>=westBorder)

ggplot(trimmed.dat, aes(Longitude, Latitude)) + geom_point(aes(colour = YldVolDry),size = 1)
```

Now, let's map a trial into one corner of the field. We will find this easier if we convert to meters. 
This will require an approximation, see http://stackoverflow.com/questions/639695/how-to-convert-latitude-or-longitude-to-meters

```{r}
trimmed.dat$LonM <- trimmed.dat$Longitude - min(trimmed.dat$Longitude)
trimmed.dat$LatM <- trimmed.dat$Latitude - min(trimmed.dat$Latitude)
latMid <- (min(trimmed.dat$Latitude) + max(trimmed.dat$Latitude))/2
m_per_deg_lat = 111132.954 - 559.822 * cos( 2.0 * latMid ) + 1.175 * cos( 4.0 * latMid)
m_per_deg_lon = (3.14159265359/180 ) * 6367449 * cos ( latMid )
trimmed.dat$LonM <- trimmed.dat$LonM*m_per_deg_lon
trimmed.dat$LatM <- trimmed.dat$LatM*m_per_deg_lat
ggplot(trimmed.dat, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size = 1)
```


```{r}
library(gstat)
sample.var <- variogram(YldVolDry~1, 
                        locations=~LonM+LatM, 
                        data=trimmed.dat)
plot(sample.var)
sample.vgm <- fit.variogram(sample.var, vgm("Exp"))
sample.vgm
```

### Simulation


```{r}
library(nlme)
```


```{r}
hoonuiaku.plan <- data.frame(
row=c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3),
col=c(1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7, 1, 2, 3, 4, 5, 6, 7),
trt=c(8, 3, 1, 6, 4, 2, 10, 4, 2, 1, 3, 5, 9, 13, 12, 3, 4, 7, 1, 2, 11),
yield=c(96, 87, 92, 89, 81, 79, 82, 91, 81, 79, 81, 79, 78, NA, 74, 78, 78, 70, 83, 77, 75)
)
adjusted <- c(78.25,86.50,73.25,93.5,77.25,79.5,78.25,77.25)
rEffects = c(-3.25,0.75,2.50)
vEffects = c(3.6042,
             -2.0625,
             0.9375,
             2.2708,
             -2.8125,
             5.4375,
             -7.8125,
             12.4375,
             -3.8125,
             -1.5625,
             -2.8125,
             -3.8125,
             0)
basemeans <- c(84.66667, 79.00000, 82.00000, 83.33333, 78.25000, 86.50000, 73.25000, 93.50000, 77.25000, 79.50000,  78.25000, 77.25000)
basemeans <- c(basemeans,mean(basemeans))

hoonuiaku.plan$blk <- hoonuiaku.plan$row
hoonuiaku.base <- hoonuiaku.plan


hoonuiaku.alt1.plan <- hoonuiaku.base
hoonuiaku.alt1.plan$trt <- c(1, 5, 2, 6, 3, 7, 4, 2, 8, 3, 9, 1, 10, 4, 2, 11, 4, 12, 1, 13, 3)

hoonuiaku.alt2.plan <- hoonuiaku.base
hoonuiaku.alt2.plan$trt <- c(10, 3, 13, 4, 5, 2, 1, 3, 9, 1, 2, 11, 4, 6, 3, 1, 8, 2, 12, 4, 7)
```


```{r}
hoonuiaku.sim <- simulate.plan(hoonuiaku.plan,trimmed.dat,plot.dim=arm.plot.dim,row.buffer=arm.row.buffer,sample.vgm=sample.vgm)
hoonuiaku1.sim <- simulate.plan(hoonuiaku.alt1.plan,trimmed.dat,plot.dim=arm.plot.dim,row.buffer=arm.row.buffer,sample.vgm=sample.vgm)
hoonuiaku2.sim <- simulate.plan(hoonuiaku.alt2.plan,trimmed.dat,plot.dim=arm.plot.dim,row.buffer=arm.row.buffer,sample.vgm=sample.vgm)
hoonuiaku.plan <- subset(hoonuiaku.plan,!is.na(hoonuiaku.plan$yield))
```

```{r}
hoonuiaku.sim$points$check <- as.factor(hoonuiaku.sim$points$trt %in% checks)
hoonuiaku1.sim$points$check <- as.factor(hoonuiaku1.sim$points$trt %in% checks)
hoonuiaku2.sim$points$check <- as.factor(hoonuiaku2.sim$points$trt %in% checks)

ggplot(hoonuiaku.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size=1)
ggplot(hoonuiaku.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = check),size=1)

ggplot(hoonuiaku1.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size=1)
ggplot(hoonuiaku1.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = check),size=1)

ggplot(hoonuiaku2.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size=1)
ggplot(hoonuiaku2.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = check),size=1)
```


### Distances
```{r}
unit.plot.dim <- c(1,1)
unit.row.buffer <- c(0,0)
hoonuiaku.plan$rep <- hoonuiaku.plan$row
hoonuiaku.pairs.dat <- pair.distances(hoonuiaku.plan, plot.dim=unit.plot.dim, row.buffer=unit.row.buffer)

```


We have three classes of pairwise comparisons.
```{r}
hoonuiaku.pairs.dat$pair.type <- "mixed"
check.mask <- 
hoonuiaku.pairs.dat$pair.type[hoonuiaku.pairs.dat$trt1 %in% checks & hoonuiaku.pairs.dat$trt2 %in% checks] <- "check"
hoonuiaku.pairs.dat$pair.type[!(hoonuiaku.pairs.dat$trt1 %in% checks) & !(hoonuiaku.pairs.dat$trt2 %in% checks)] <- "unrep"
hoonuiaku.pairs.dat$pair.type <- as.factor(hoonuiaku.pairs.dat$pair.type)
hoonuiaku.pairs.dat
```

Types of comparisons
--------------------

We have three classes of treatment pairs - Among checks, among unreplicated and between checks and unreplicated. We also have two groupings - within replicates only and across replicates.

We have 6 combinations from with to compute average contrast distances.

To summarize by treatment, we have checks and unreplicated, we can sum
checks among checks, checks among untreated, checks across all, 

### All pairs

```{r}
tapply(hoonuiaku.pairs.dat$distance,hoonuiaku.pairs.dat$pair.type,mean)
tapply(hoonuiaku.pairs.dat$distance,hoonuiaku.pairs.dat$pair.type,sd)
```

```{r}
ggplot(hoonuiaku.pairs.dat, aes(distance, fill=pair.type)) + geom_histogram(bins=6)
```

To compute means for treatments, 

```{r}
hoonuiaku.pairs.table <- make.pairs.table(hoonuiaku.pairs.dat)
hoonuiaku.pairs.table
hoonuiaku.mat <- make.pairs.matrices(hoonuiaku.pairs.table)
hoonuiaku.mat
```

Case 1
```{r}
hoonuiaku.all <- rowMeans(hoonuiaku.mat$mean,na.rm=TRUE)
hoonuiaku.all
apply(hoonuiaku.mat$mean,1,mean,na.rm=TRUE)
apply(hoonuiaku.mat$mean,1,sd,na.rm=TRUE)
hoonuiaku.checks <- rowMeans(hoonuiaku.mat$mean[,checks],na.rm=TRUE)
hoonuiaku.unrep <- rowMeans(hoonuiaku.mat$mean[,unreplicated],na.rm=TRUE)
```


```{r}
distances <- c()
adjacency <- c()
grouping <- c()
across <- c()
treatments <- c()
nonran <- c()
twiddled <- c()
contrast.type <- c()

distances <- c(distances,hoonuiaku.all)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.all)))
grouping <- c(grouping,rep("All",length(hoonuiaku.all)))
across <- c(across,rep(TRUE,length(hoonuiaku.all)))
nonran <- c(nonran,rep(1,length(hoonuiaku.all)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.all)))
treatments <- c(treatments,1:length(hoonuiaku.all))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.all)))
distances <- c(distances,hoonuiaku.checks)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.checks)))
grouping <- c(grouping,rep("Checks",length(hoonuiaku.checks)))
across <- c(across,rep(TRUE,length(hoonuiaku.checks)))
nonran <- c(nonran,rep(1,length(hoonuiaku.checks)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.checks)))
treatments <- c(treatments,1:length(hoonuiaku.checks))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.checks)))
distances <- c(distances,hoonuiaku.unrep)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.unrep)))
grouping <- c(grouping,rep("Unreplicated",length(hoonuiaku.unrep)))
across <- c(across,rep(TRUE,length(hoonuiaku.unrep)))
nonran <- c(nonran,rep(1,length(hoonuiaku.unrep)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.unrep)))
treatments <- c(treatments,1:length(hoonuiaku.unrep))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.unrep)))
```


### Within replicate

```{r}
hoonuiaku.pairs.rep.dat <- subset(hoonuiaku.pairs.dat,hoonuiaku.pairs.dat$rep1==hoonuiaku.pairs.dat$rep2)
hoonuiaku.pairs.rep.dat
ggplot(hoonuiaku.pairs.rep.dat, aes(distance, fill=pair.type)) + geom_histogram(bins=6)
tapply(hoonuiaku.pairs.rep.dat$distance,hoonuiaku.pairs.rep.dat$pair.type,mean)
tapply(hoonuiaku.pairs.dat$distance,hoonuiaku.pairs.dat$pair.type,sd)
```


```{r}
hoonuiaku.pairs.rep.table <- make.pairs.table(hoonuiaku.pairs.rep.dat)
hoonuiaku.pairs.rep.table
hoonuiaku.rep.mat <- make.pairs.matrices(hoonuiaku.pairs.rep.table)
hoonuiaku.rep.mat

hoonuiaku.rep.all <- rowMeans(hoonuiaku.rep.mat$mean,na.rm=TRUE)
hoonuiaku.rep.all
apply(hoonuiaku.rep.mat$mean,1,mean,na.rm=TRUE)
apply(hoonuiaku.rep.mat$mean,1,sd,na.rm=TRUE)

hoonuiaku.rep.checks <- rowMeans(hoonuiaku.rep.mat$mean[,checks],na.rm=TRUE)
hoonuiaku.rep.unrep <- rowMeans(hoonuiaku.rep.mat$mean[,unreplicated],na.rm=TRUE)
```



```{r}
distances <- c(distances,hoonuiaku.rep.all)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.rep.all)))
grouping <- c(grouping,rep("All",length(hoonuiaku.rep.all)))
across <- c(across,rep(FALSE,length(hoonuiaku.rep.all)))
nonran <- c(nonran,rep(1,length(hoonuiaku.rep.all)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.rep.all)))
treatments <- c(treatments,1:length(hoonuiaku.rep.all))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.rep.all)))

distances <- c(distances,hoonuiaku.rep.checks)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.rep.checks)))
grouping <- c(grouping,rep("Checks",length(hoonuiaku.rep.checks)))
across <- c(across,rep(FALSE,length(hoonuiaku.rep.checks)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.rep.checks)))
nonran <- c(nonran,rep(1,length(hoonuiaku.rep.checks)))
treatments <- c(treatments,1:length(hoonuiaku.rep.checks))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.rep.checks)))

distances <- c(distances,hoonuiaku.rep.unrep)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.rep.unrep)))
grouping <- c(grouping,rep("Unreplicated",length(hoonuiaku.rep.unrep)))
across <- c(across,rep(FALSE,length(hoonuiaku.rep.unrep)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.rep.unrep)))
nonran <- c(nonran,rep(1,length(hoonuiaku.rep.unrep)))
treatments <- c(treatments,1:length(hoonuiaku.rep.unrep))
contrast.type <- c(contrast.type,rep("All",length(hoonuiaku.rep.unrep)))
```

### Unreplicated-Check contrasts only

```{r}
hoonuiaku.pairs.mixed.dat <- subset(hoonuiaku.pairs.rep.dat,hoonuiaku.pairs.rep.dat$pair.type=="mixed")
hoonuiaku.pairs.mixed.dat
ggplot(hoonuiaku.pairs.mixed.dat, aes(distance, fill=pair.type)) + geom_histogram(bins=6)

tapply(hoonuiaku.pairs.mixed.dat$distance,hoonuiaku.pairs.mixed.dat$pair.type,mean)
tapply(hoonuiaku.pairs.dat$distance,hoonuiaku.pairs.dat$pair.type,sd)

hoonuiaku.pairs.mixed.table <- make.pairs.table(hoonuiaku.pairs.mixed.dat)
hoonuiaku.pairs.mixed.table
hoonuiaku.mixed.mat <- make.pairs.matrices(hoonuiaku.pairs.mixed.table)
hoonuiaku.mixed.mat

hoonuiaku.mixed.all <- rowMeans(hoonuiaku.mixed.mat$mean,na.rm=TRUE)
hoonuiaku.mixed.all
apply(hoonuiaku.mixed.mat$mean,1,mean,na.rm=TRUE)
apply(hoonuiaku.mixed.mat$mean,1,sd,na.rm=TRUE)
apply(hoonuiaku.mixed.mat$mean,2,mean,na.rm=TRUE)
apply(hoonuiaku.mixed.mat$mean,2,sd,na.rm=TRUE)

hoonuiaku.mixed.checks <- colMeans(hoonuiaku.mixed.mat$mean[,checks],na.rm=TRUE)
hoonuiaku.mixed.checks
hoonuiaku.mixed.unrep <- hoonuiaku.mixed.all#rowMeans(hoonuiaku.mixed.mat$mean[,unreplicated],na.rm=TRUE)
hoonuiaku.mixed.all[1:4] <- hoonuiaku.mixed.checks
hoonuiaku.mixed.checks <- c(hoonuiaku.mixed.checks,rep(NA,8))

distances <- c(distances,hoonuiaku.mixed.all)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.mixed.all)))
grouping <- c(grouping,rep("All",length(hoonuiaku.mixed.all)))
across <- c(across,rep(FALSE,length(hoonuiaku.mixed.all)))
nonran <- c(nonran,rep(1,length(hoonuiaku.mixed.all)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.mixed.all)))
treatments <- c(treatments,1:length(hoonuiaku.mixed.all))
contrast.type <- c(contrast.type,rep("Mixed",length(hoonuiaku.mixed.all)))

distances <- c(distances,hoonuiaku.mixed.checks)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.mixed.checks)))
grouping <- c(grouping,rep("Checks",length(hoonuiaku.mixed.checks)))
across <- c(across,rep(FALSE,length(hoonuiaku.mixed.checks)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.mixed.checks)))
nonran <- c(nonran,rep(1,length(hoonuiaku.mixed.checks)))
treatments <- c(treatments,1:length(hoonuiaku.mixed.checks))
contrast.type <- c(contrast.type,rep("Mixed",length(hoonuiaku.mixed.checks)))

distances <- c(distances,hoonuiaku.mixed.unrep)
adjacency <- c(adjacency,rep(0,length(hoonuiaku.mixed.unrep)))
grouping <- c(grouping,rep("Unreplicated",length(hoonuiaku.mixed.unrep)))
across <- c(across,rep(FALSE,length(hoonuiaku.mixed.unrep)))
twiddled <- c(twiddled,rep(FALSE,length(hoonuiaku.mixed.unrep)))
nonran <- c(nonran,rep(1,length(hoonuiaku.mixed.unrep)))
treatments <- c(treatments,1:length(hoonuiaku.mixed.unrep))
contrast.type <- c(contrast.type,rep("Mixed",length(hoonuiaku.mixed.unrep)))
```


### Comparisons
```{r}
comp.dat <- data.frame(
  distance = distances,
  adjacency = as.factor(adjacency),
  grouping = as.factor(grouping),
  across = as.factor(across),
  nonran = as.factor(nonran),
  twiddled = as.factor(twiddled),
  contrast.type = as.factor(contrast.type),
  treatment = treatments
)
comp.dat$check <- comp.dat$treatment %in% checks
comp.dat$check <- as.factor(comp.dat$check)
comp.dat$class <-  comp.dat$grouping : comp.dat$adjacency : comp.dat$nonran : comp.dat$across
```



```{r}
ggplot(comp.dat, aes(distance,color=across,fill=across)) + geom_histogram(position="dodge")

ggplot(comp.dat, aes(distance,color=adjacency,fill=adjacency)) + stat_density(geom="line",position="identity")
ggplot(comp.dat, aes(distance,color=grouping,fill=grouping)) + stat_density(geom="line",position="identity")
ggplot(comp.dat, aes(distance,color=across,fill=across)) + stat_density(geom="line",position="identity")

ggplot(comp.dat, aes(distance,color=class,fill=class)) + stat_density(geom="line",position="identity")
```

### Slide 1
Compare checks in ranks, at edge and centered
```{r}
slide1.dat <- subset(comp.dat,comp.dat$across==FALSE)
head(slide1.dat)
slide1.dat <- subset(slide1.dat,slide1.dat$contrast.type=="All")
ggplot(slide1.dat, aes(distance,color=grouping,fill=grouping,linetype=grouping)) + stat_density(geom="line",position="identity",size=2)
ggplot(slide1.dat, aes(distance,color=grouping,fill=grouping,linetype=grouping)) + geom_histogram(position="dodge")
slide1.dat$treatment <- as.factor(slide1.dat$treatment)
ggplot(slide1.dat, aes(treatment, distance)) + geom_point(aes(color=grouping,shape=grouping),size=3)
```

```{r}
slide2.dat <- subset(comp.dat,comp.dat$across==TRUE)
slide2.dat <- subset(slide2.dat,slide2.dat$contrast.type=="All")
slide2.dat$treatment <- as.factor(slide2.dat$treatment)
ggplot(slide2.dat, aes(distance,color=grouping,fill=grouping,linetype=grouping)) + stat_density(geom="line",position="identity",size=2)
ggplot(slide2.dat, aes(treatment, distance)) + geom_point(aes(color=grouping,shape=grouping),size=3)
```

```{r}
slide3.dat <- subset(comp.dat,comp.dat$across==FALSE)
slide3.dat <- subset(slide3.dat,slide3.dat$contrast.type=="Mixed")
slide3.dat$treatment <- as.factor(slide3.dat$treatment)
ggplot(slide3.dat, aes(distance,color=grouping,fill=grouping,linetype=grouping)) + stat_density(geom="line",position="identity",size=2)
ggplot(slide3.dat, aes(treatment, distance)) + geom_point(aes(color=grouping,shape=grouping),size=3)
```

```{r}
slide4.dat <- subset(comp.dat,comp.dat$across==FALSE)
slide4.dat$treatment <- as.factor(slide4.dat$treatment)
ggplot(slide4.dat, aes(distance,color=contrast.type,fill=contrast.type,linetype=contrast.type)) + stat_density(geom="line",position="identity",size=2)
ggplot(slide4.dat, aes(treatment, distance)) + geom_point(aes(color=contrast.type,shape=contrast.type),size=3)
```


### Trial Simulation
```{r}
library(agricolae)
err1 <- c()
err2 <- c()
err3 <- c()
err4 <- c()
pln <- c()

adjmeans <- c()
trts <- c()
refmeans <- c()
meanspln <- c()
meannum <- c()

hoonuiaku.sim$points <- subset(hoonuiaku.sim$points,!is.na(hoonuiaku.sim$points$number))
hoonuiaku1.sim$points <- subset(hoonuiaku1.sim$points,!is.na(hoonuiaku1.sim$points$number))
hoonuiaku2.sim$points <- subset(hoonuiaku2.sim$points,!is.na(hoonuiaku2.sim$points$number))
```

```{r}
hoonuiaku.sim$points$YldVolDry <- hoonuiaku.sim$points$YldVolDry +
vEffects[as.numeric(as.character(hoonuiaku.sim$points$trt))]
hoonuiaku1.sim$points$YldVolDry <- hoonuiaku1.sim$points$YldVolDry +
vEffects[hoonuiaku1.sim$points$trt]
#hoonuiaku2.sim$points$YldVolDry <- hoonuiaku2.sim$points$YldVolDry + rEffects[hoonuiaku2.sim$points$blk] +vEffects[hoonuiaku2.sim$points$trt]
hoonuiaku2.sim$points$YldVolDry <- hoonuiaku2.sim$points$YldVolDry + rEffects[hoonuiaku2.sim$points$blk] 

for (exp in 1:max(hoonuiaku.sim$points$number)) {
  current.dat <- subset(hoonuiaku.sim$points,hoonuiaku.sim$points$number==exp)
  current.test <- DAU.test(current.dat$blk,current.dat$trt,current.dat$YldVolDry,method="lsd", group=TRUE)
  #print(current.test$SE.difference)
  if(length(current.test$means$mean.adj)==13) {
    adjmeans <- c(adjmeans,current.test$means$mean.adj-mean(current.test$means$mean.adj))
    trts <- c(trts,1:13)
    refmeans <- c(refmeans,vEffects)
    meanspln <- c(meanspln,rep(0,13))
    meannum <- c(meannum,rep(exp,13))
  } else {
    adjmeans <- c(adjmeans,rep(NA,13))
    trts <- c(trts,1:13)
    refmeans <- c(refmeans,vEffects)
    meanspln <- c(meanspln,rep(0,13))
    meannum <- c(meannum,rep(exp,13))
  }

  err1 <- c(err1,current.test$SE.difference[1])
  err2 <- c(err2,current.test$SE.difference[2])
  err3 <- c(err3,current.test$SE.difference[3])
  err4 <- c(err4,current.test$SE.difference[4])
  pln <- c(pln,0)
}

for (exp in 1:max(hoonuiaku1.sim$points$number)) {
  current.dat <- subset(hoonuiaku1.sim$points,hoonuiaku1.sim$points$number==exp)
  current.test <- DAU.test(current.dat$blk,current.dat$trt,current.dat$YldVolDry,method="lsd", group=TRUE)
  #print(current.test$SE.difference)
  
  adjmeans <- c(adjmeans,current.test$means$mean.adj-mean(current.test$means$mean.adj))
    trts <- c(trts,1:13)
    refmeans <- c(refmeans,vEffects)
    meanspln <- c(meanspln,rep(1,13))
    meannum <- c(meannum,rep(exp,13))
    
  err1 <- c(err1,current.test$SE.difference[1])
  err2 <- c(err2,current.test$SE.difference[2])
  err3 <- c(err3,current.test$SE.difference[3])
  err4 <- c(err4,current.test$SE.difference[4])
  pln <- c(pln,1)
}

for (exp in 1:max(hoonuiaku2.sim$points$number)) {
  current.dat <- subset(hoonuiaku2.sim$points,hoonuiaku2.sim$points$number==exp)
  current.test <- DAU.test(current.dat$blk,current.dat$trt,current.dat$YldVolDry,method="lsd", group=TRUE)
  #print(current.test$SE.difference)
  
  adjmeans <- c(adjmeans,current.test$means$mean.adj-mean(current.test$means$mean.adj))
    trts <- c(trts,1:13)
    refmeans <- c(refmeans,vEffects)
    meanspln <- c(meanspln,rep(2,13))
    meannum <- c(meannum,rep(exp,13))
    
  err1 <- c(err1,current.test$SE.difference[1])
  err2 <- c(err2,current.test$SE.difference[2])
  err3 <- c(err3,current.test$SE.difference[3])
  err4 <- c(err4,current.test$SE.difference[4])
  pln <- c(pln,2)
}

compsim.dat <- data.frame(
  err1=err1,
  err2=err2,
  err3=err3,
  err4=err4,
  pln=as.factor(pln)
)
compmeans.dat <- data.frame(
  adjmeans=adjmeans,
  trts=trts,
  refmeans=refmeans,
  meanspln=meanspln
)
```

````{r}
ggplot(compsim.dat, aes(err4,color=pln,fill=pln,linetype=pln)) + stat_density(geom="line",position="identity",size=2)
```

```{r}
head(subset(compmeans.dat,!is.na(compmeans.dat$adjmeans)))
compmeans.dat$trts <- as.factor(compmeans.dat$trts)
compmeans.dat$meanspln <- as.factor(compmeans.dat$meanspln)
ggplot(subset(compmeans.dat,!is.na(compmeans.dat$adjmeans)), aes(as.factor(refmeans),adjmeans)) + #geom_point(aes(color=meanspln),size=2) +
geom_boxplot(aes(fill = factor(meanspln))) 

compmeans.dat$estdiff <- compmeans.dat$adjmeans-compmeans.dat$refmeans

ggplot(subset(compmeans.dat,!is.na(compmeans.dat$adjmeans)), aes(as.factor(refmeans),estdiff)) + #geom_point(aes(color=meanspln),size=2) +
geom_boxplot(aes(fill = factor(meanspln))) 

tapply(compmeans.dat$estdiff,list(compmeans.dat$trts,compmeans.dat$meanspln),mean)
tapply(compmeans.dat$estdiff,list(compmeans.dat$trts,compmeans.dat$meanspln),sd)
tapply(compmeans.dat$estdiff,list(compmeans.dat$meanspln),mean)
tapply(compmeans.dat$estdiff,list(compmeans.dat$meanspln),sd)

lm(adjmeans ~ meanspln:refmeans,data=compmeans.dat)
```



