---
title: "Exploring Treatment x Trial
  Interactions using Treatment Stability/Trial Dendrogram plots"
author: "Peter Claussen"
date: "October 15, 2015"
output: html_document
---


Here I use the CPT 2007 data set to illustrate new options avialable for ST Treatment Stability/Trial Dendrogram plots.

```{r,echo=FALSE}
library(ARMR)
source("../ASA_CSSA_SSSA/R/gei.table.to.frame.R")
source("../ASA_CSSA_SSSA/R/nonadditivity.gei.R")
source("../ASA_CSSA_SSSA/R/heterogeneity.gei.R")
source("../ASA_CSSA_SSSA/R/standard.sensitivity.plot.R")
source("../ASA_CSSA_SSSA/R/expand.incidence.R")
source("../ASA_CSSA_SSSA/R/decompose.means.table.R")
source("../ASA_CSSA_SSSA/R/interaction.outliers.R")
source("../ASA_CSSA_SSSA/R/plot.interaction.ARMST.R")
```

### Multilocation

Using scripts from ARM ST to show options.
```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
cbColors <- c(cbPalette,cbbPalette)
path = "../Manuscripts/scripts/multilocation"
means.vector <- read.delim('../Manuscripts/scripts/multilocation/trialMeans.SmyCol1.tab',header=FALSE)
means.matrix <- read.delim('../Manuscripts/scripts/multilocation/trialTable.SmyCol1.tab',header=FALSE)
means.vector <- means.vector[,1]
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 6, 2, 1) + 0.1), ps = 12, cex.lab = 1.166667, cex.main = 1.333333, cex.axis = 1)
res1<-plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean \nYield',regression=TRUE, main='Treatment Stability and Trial Clusters for Grand Mean 1', show.legend=TRUE,legend.columns=1, legend.pos=c(.01,.98),trt.colors=cbColors)
par(fig=c(0,1,0,.4),mar=(c(4, 6, 0, 1) + 0.1), new=TRUE)
res2<-plot.clusters.ARMST(means.matrix, means.vector, xlab='Trial Mean \nMultilocation', ylab='',trt.colors =cbColors)
par(fig = c(0, 1, 0, 1))
```

```{r}
path = "../Manuscripts/scripts/multilocation"
means.vector <- read.delim('../Manuscripts/scripts/multilocation/trialMeans.SmyCol1.tab',header=FALSE)
means.matrix <- read.delim('../Manuscripts/scripts/multilocation/trialTable.SmyCol1.tab',header=FALSE)
means.vector <- means.vector[,1]
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 6, 2, 1) + 0.1), ps = 12, cex.lab = 1.166667, cex.main = 1.333333, cex.axis = 1)
res1<-plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean \nYield',regression=TRUE, main='Treatment Stability and Trial Clusters for Grand Mean 1', show.legend=TRUE,legend.columns=1, legend.pos=c(.01,.98),trt.colors=cbColors)
par(fig=c(0,1,0,.4),mar=(c(4, 6, 0, 1) + 0.1), new=TRUE)
decomp <- decompose.means.table(means.matrix)
fg="black"
res2<-plot.clusters.ARMST(means.matrix, means.vector, fg=fg,xlab='Trial Mean \nMultilocation', ylab='',reference=(decomp$mu + decomp$alpha + decomp$beta),trt.colors=cbColors)
fg=cbColors[2]

res3 <- plot.clusters.ARMST(decomp$mu + decomp$alpha + decomp$beta, means.vector, fg=fg,add=TRUE,xlab='Trial Mean \nMultilocation', ylab='',trt.colors=cbColors)
par(fig = c(0, 1, 0, 1))
```

```{r}
str(res2$means.hc)

res2$means.hc$height
res3$means.hc$height

res2$means.hc$height/res3$means.hc$height
res2$means.hc$order
res3$means.hc$order

res2$means.hc$merge
res3$means.hc$merge

res2$means.hc$merge==res3$means.hc$merge

matched.idx <- compare.merges(res2$means.hc$merge,res3$means.hc$merge)
matched.idx
res2$means.hc$height
res3$means.hc$height
res3$means.hc$height[matched.idx]
```


The function cluster.stats() in the fpc package provides a mechanism for comparing the similarity of two cluster solutions using a variety of validation criteria (Hubert's gamma coefficient, the Dunn index and the corrected rand index)
# comparing 2 cluster solutions

```{r}
library(fpc)
d <- dist(means.matrix)
cluster.stats(d, res2$clusters, res3$clusters)
```

where d is a distance matrix among objects, and fit1$cluster and fit$cluster are integer vectors containing classification results from two different clusterings of the same data.


```{r}
library(SASmixed)
data(Multilocation)
mixed.res <- standard.sensitivity.plot(Multilocation,
                                     response = "Adj",
                          TreatmentName = "Trt",
                          TrialName = "Location",
                          RepName="Block",
                          dual.dendrogram=TRUE,
                          plot.outliers=TRUE,legend.columns=1)
print.stdplot(mixed.res)

```



```{r}
response = "Plot.Mean"
TreatmentName = "Criteria.Entry.No."
TrialName = "Expt.No."
RepName="Rep.No."
#yield.desc ="Yield"
#tw.desc="Test Weight"
#hd.desc="Heading"
#ht.desc="Test Weight"
#cpt.dat <- read.csv("CPT.full.subset.csv",header=TRUE)
#cpt.dat <- read.csv("CPT_2007Subsetb.csv",header=TRUE)


yield.desc ="GY"
tw.desc ="TW"
hd.desc="HD"
ht.desc="HT"
cpt.dat <- read.delim("CPT_2007Subset.txt",header=TRUE)
cpt.dat <- subset(cpt.dat,!is.na(cpt.dat$Plot.Mean))
cpt.dat$Expt.No. <- as.factor(cpt.dat$Expt.No.)
TrtNames <- as.character(cpt.dat$Criteria.Entry.No.)
TrtNames[cpt.dat$Criteria.Entry.No.<10] <- paste("0",TrtNames[cpt.dat$Criteria.Entry.No.<10],sep="")
cpt.dat$Criteria.Entry.No. <- as.factor(TrtNames)
cpt.dat$Rep.No. <- as.factor(cpt.dat$Rep.No.)
gy.dat <- subset(cpt.dat,cpt.dat$Description==yield.desc)
tw.dat <- subset(cpt.dat,cpt.dat$Description==tw.desc)
hd.dat <- subset(cpt.dat,cpt.dat$Description==hd.desc)
ht.dat <- subset(cpt.dat,cpt.dat$Description==ht.desc)

gy.dat$Expt.No. <- as.factor(as.character(gy.dat$Expt.No.))
tw.dat$Expt.No. <- as.factor(as.character(tw.dat$Expt.No.))
hd.dat$Expt.No. <- as.factor(as.character(hd.dat$Expt.No.))
ht.dat$Expt.No. <- as.factor(as.character(ht.dat$Expt.No.))
```

```{r}
gy.means <- gei.table.and.effects(gy.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName)
gy.means$trial.means
colMeans(gy.means$means.table)
gy.res <- standard.sensitivity.plot(gy.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          dual.dendrogram=FALSE,
                          plot.outliers=TRUE,legend.columns=3)
gy.res <- standard.sensitivity.plot(gy.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          outliers=2.4,
                          dual.dendrogram=TRUE,
                          plot.outliers=TRUE,legend.columns=3)

print.stdplot(gy.res)

gyb.res <- standard.sensitivity.plot(gy.dat,
                          response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          outliers=2,
                          method="ave",
                          plot.outliers=TRUE,legend.columns=3)

gy2.res <- standard.sensitivity.plot(gy.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          outliers=2.4,
                          dual.dendrogram=TRUE,
                          method="ave",
                          plot.outliers=TRUE,legend.columns=3)

means.matrix <- tapply(gy.dat$Plot.Mean,list(gy.dat$Criteria.Entry.No.,gy.dat$Expt.No.),mean)
decomp <- decompose.means.table(means.matrix)
txt.matrix <- decomp$gamma
mean(unlist(txt.matrix),na.rm=TRUE)
max <- sd(unlist(txt.matrix),na.rm=TRUE)
norm.mat <- abs(txt.matrix)
crit <- 3*max
gy.means$means.table - means.matrix

gy.res$cluster$score/gy.res$add.cluster$score
gy.res$cluster$clusters
gy.res$add.cluster$clusters
gy.res$cluster$means.hc$height
gy.res$add.cluster$means.hc$height

gy.res$cluster$means.hc$height/gy.res$add.cluster$means.hc$height
gy.res$cluster$means.hc$order
gy.res$add.cluster$means.hc$order

gy.res$cluster$means.hc$merge
gy.res$add.cluster$means.hc$merge

gy.res$cluster$means.hc$merge==gy.res$add.cluster$means.hc$merge

tdf.tbl <- anova(gy.res$tdf$multiplicative.lm)
aov.tbl <- gy.res$aov
tdf.tbl
aov.tbl
recompute.tdf.aov(tdf.tbl,aov.tbl)
```


  last = dim(aov.tbl)[1]
  last.row <- aov.tbl[last,]
  tdf.last <- dim(tdf.tbl)[1]
  colnames(last.row) <- colnames(tdf.tbl)
  tdf.tbl <- rbind(tdf.tbl,last.row)
  #compute interaction residuals by subtracting 1df row from txt row
  tdf.tbl[tdf.last,] <- aov.tbl[last-1,] - tdf.tbl[tdf.last-1,]
  #recompute residuals
  tdf.tbl[tdf.last,3] <- tdf.tbl[tdf.last,2]/tdf.tbl[tdf.last,1]
  #test treatment:trial against interaction residual
  tdf.tbl[tdf.last-1,4] <- tdf.tbl[tdf.last-1,3]/tdf.tbl[tdf.last,3]
  tdf.tbl[tdf.last-1,5] <- 1-pf(tdf.tbl[tdf.last-1,4],tdf.tbl[tdf.last-1,1],tdf.tbl[tdf.last,1])
  
  #test interaction residual against experimental residual
  tdf.tbl[tdf.last,4] <- tdf.tbl[tdf.last,3]/last.row[3]
  tdf.tbl[tdf.last,5] <- 1-pf(tdf.tbl[tdf.last,4],tdf.tbl[tdf.last,1],as.numeric(last.row[1]))
  
  return(tdf.tbl)
  

```

```{r}
tw.res <- standard.sensitivity.plot(tw.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          dual.dendrogram=TRUE,
                          plot.outliers=TRUE,legend.columns=3)

print.stdplot(tw.res)
tw.res$cluster$score/tw.res$add.cluster$score
tw.res <- standard.sensitivity.plot(tw.dat,
                                     response = response,
                          TreatmentName = TreatmentName,
                          TrialName = TrialName,
                          RepName=RepName,
                          dual.dendrogram=FALSE,
                          plot.outliers=TRUE,legend.columns=3)


```


```{r}
gy.matrix <- data.frame(tapply(gy.dat$Plot.Mean,list(gy.dat$Expt.No.,gy.dat$Criteria.Entry.No.),mean))
gy.vector <- tapply(gy.dat$Plot.Mean,list(gy.dat$Expt.No.),mean)

par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
gy.table <- plot.interaction.ARMST(gy.matrix, gy.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='GY', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
gy.hc <- plot.clusters.ARMST(gy.matrix, gy.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))

tw.matrix <- data.frame(tapply(tw.dat$Plot.Mean,list(tw.dat$Expt.No.,tw.dat$Criteria.Entry.No.),mean))
tw.vector <- tapply(tw.dat$Plot.Mean,list(tw.dat$Expt.No.),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
tw.table <- plot.interaction.ARMST(tw.matrix, tw.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='TW', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
tw.hc <- plot.clusters.ARMST(tw.matrix, tw.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))

hd.matrix <- data.frame(tapply(hd.dat$Plot.Mean,list(hd.dat$Expt.No.,hd.dat$Criteria.Entry.No.),mean))
hd.vector <- tapply(hd.dat$Plot.Mean,list(hd.dat$Expt.No.),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
hd.table <- plot.interaction.ARMST(hd.matrix, hd.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='HD', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
hd.hc <- plot.clusters.ARMST(hd.matrix, hd.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))


ht.matrix <- data.frame(tapply(ht.dat$Plot.Mean,list(ht.dat$Expt.No.,ht.dat$Criteria.Entry.No.),mean))
ht.vector <- tapply(ht.dat$Plot.Mean,list(ht.dat$Expt.No.),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
ht.table <- plot.interaction.ARMST(ht.matrix, ht.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='HT', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
ht.hc <- plot.clusters.ARMST(ht.matrix, ht.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))
```


```{r}
library(agridat)
data(pacheco.soybean)
mixed.res <- standard.sensitivity.plot(pacheco.soybean,
                                     response = "yield",
                          TreatmentName = "gen",
                          TrialName = "env",
                          dual.dendrogram=TRUE,
                          plot.outliers=TRUE,legend.columns=3)
print.stdplot(mixed.res)
```

```{r}
data(cornelius.maize)
mixed.res <- standard.sensitivity.plot(cornelius.maize,
                                     response = "yield",
                          TreatmentName = "gen",
                          TrialName = "env",
                          dual.dendrogram=TRUE,
                          plot.outliers=TRUE,legend.columns=3)
print.stdplot(mixed.res)

tdf.tbl <- anova(mixed.res$tdf$multiplicative.lm)
anova(mixed.res$tdf$multiplicative.lm)
summary(mixed.res$tdf$multiplicative.lm)
```

Working backwards, standard error for genotype estimates, the heterogeneous null model, is 560.6/sqrt(20), but I still haven't worked out the SE for heterogeneous slopes. Still, if we assume balanced, then we can use the given standard error

sqrt(357703)/sqrt(8406983)

ee <- mixed.res$tdf$multiplicative.lm$model$egen*mixed.res$tdf$multiplicative.lm$model$eenv
> sum(ee*ee)
[1] 2.743446e+13
> sqrt(357703/2.743446e+13)
[1] 0.0001141861


SE = sb1 = sqrt [ Σ(yi - ŷi)2 / (n - 2) ] / sqrt [ Σ(xi - x)2 ]