---
title: "Uniformity Simulations"
author: "Peter Claussen"
date: "May 18, 2016"
output: html_document
---


Multiple Trial Simulations
--------------------------

```{r}
currentwd <- getwd()
setwd("~/Work/git/ASA_CSSA_SSSA/ASA_CSSA_SSSA/R")
source("pair.distances.R")
source("plot.distance.R")
source("superimpose.plan.R")
source("simulate.plan.R")
source("trial.dimensions.R")
setwd(currentwd)

arm.plot.dim <- c(4,6)
arm.row.buffer <- c(0.5,1)
set.seed(10000)

sample.vgm <- NULL
```

```{r}
library(ggplot2)
library(agricolae)
```


Simulation
----------

Assume we have yield (or other agronomic assessment) data in spatial format, such as yield monitor data.
For example, this data from the SDSU research statio near Beresford. This file has been edited from the original format and is comma-seperated.


```{r}
raw.dat <- read.csv("./data/sdsu/Swest_Corn2013-Clean.csv", header = TRUE)
    response <- "YldVolDry"
    hist(raw.dat[,response],main=response)

    minLon <- min(raw.dat$Longitude)
    maxLon <- max(raw.dat$Longitude)
    minLat <- min(raw.dat$Latitude)
    maxLat <- max(raw.dat$Latitude)

    northBorder <- maxLat - 0.06*(maxLat-minLat)
    southBorder <- minLat + 0.09*(maxLat-minLat)
    eastBorder <- maxLon - 0.02*(maxLon-minLon)
    westBorder <- minLon + 0.02*(maxLon-minLon)

    trimmed.dat <- subset(raw.dat,raw.dat$Latitude>=southBorder)
    trimmed.dat <- subset(trimmed.dat,trimmed.dat$Latitude<=northBorder)
    trimmed.dat <- subset(trimmed.dat,trimmed.dat$Longitude<=eastBorder)
    trimmed.dat <- subset(trimmed.dat,trimmed.dat$Longitude>=westBorder)

    ggplot(trimmed.dat, aes(Longitude, Latitude)) + geom_point(aes(colour = YldVolDry),size = 1)

#convert to meters. 
#This will require an approximation, see http://stackoverflow.com/questions/639695/how-to-convert-latitude-or-longitude-to-meters

    trimmed.dat$LonM <- trimmed.dat$Longitude - min(trimmed.dat$Longitude)
    trimmed.dat$LatM <- trimmed.dat$Latitude - min(trimmed.dat$Latitude)
    latMid <- (min(trimmed.dat$Latitude) + max(trimmed.dat$Latitude))/2
    m_per_deg_lat = 111132.954 - 559.822 * cos( 2.0 * latMid ) + 1.175 * cos( 4.0 * latMid)
    m_per_deg_lon = (3.14159265359/180 ) * 6367449 * cos ( latMid )
    trimmed.dat$LonM <- trimmed.dat$LonM*m_per_deg_lon
    trimmed.dat$LatM <- trimmed.dat$LatM*m_per_deg_lat
    ggplot(trimmed.dat, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size = 1)

      library(gstat)
  sample.var <- variogram(YldVolDry~1, 
                        locations=~LonM+LatM, 
                        data=trimmed.dat)
  sample.vgm <- fit.variogram(sample.var, vgm("Exp"))
```



### Simulation

```{r}
library(nlme)
```


We might want to compare later to spatially balanced plans, so for now create a trial from vanEs.

```{r}
plan8x14.plan <- data.frame(
row=c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8),
col=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14,1,2,3,4,5,6,7,8,9,10,11,12,13,14),
trt=as.factor(c(1,12,14,6,5,8,2,7,10,11,13,4,9,3,5,7,1,9,8,4,11,13,6,12,10,2,3,14,7,10,11,14,9,1,6,12,13,3,4,5,2,8,6,4,10,1,3,5,8,14,11,13,9,12,7,2,11,8,3,12,1,7,4,6,2,9,14,10,13,5,13,1,2,11,4,14,7,3,5,6,12,9,8,10,12,11,5,4,10,2,1,9,14,8,3,7,13,6,4,14,8,7,13,12,10,1,3,5,2,11,6,9))
)

plan8x14.plan$blk <- as.factor(plan8x14.plan$row)
plan8x14.plan$rep <- as.factor(plan8x14.plan$blk)
```


```{r}
plan8x14sw <- superimpose.plan(plan8x14.plan,
                           map.data=trimmed.dat,
                           start.point=c(3,3),
                           plot.dim=arm.plot.dim,
                           row.buffer=arm.row.buffer,sample.vgm=sample.vgm
                           )
plan8x14sw$plan
```

This function returns the points in the original data
```{r}
ggplot(plan8x14sw$trial, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size = 6)
```

And the yield estimated by kriging at the center points for each plot
```{r}
ggplot(plan8x14sw$plan, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size = 4)
```

And a pooled plot
```{r}
ggplot(plan8x14sw$pooled, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry,shape=Sample),size = 4)
```

Now we repeat this plan over the entire field.

```{r}
plan8x14.sim <- simulate.plan(plan8x14.plan,
                              trimmed.dat,
                              plot.dim=arm.plot.dim,
                              row.buffer=arm.row.buffer,
                              sample.vgm=sample.vgm)

ggplot(plan8x14.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = YldVolDry),size=1)
ggplot(plan8x14.sim$points, aes(LonM, LatM)) + geom_point(aes(colour = trt),size=1)
```

The simulation returns a standard RCB aov

```{r}
ggplot(plan8x14.sim$aov, aes(TrtP)) + stat_density(geom="line",position="identity",size=1)
```

```{r}
plan8x14.sim$aov$TypeIError <- plan8x14.sim$aov$TrtP<0.05

sum(plan8x14.sim$aov$TypeIError)
length(plan8x14.sim$aov$TypeIError)
sum(plan8x14.sim$aov$TypeIError)/length(plan8x14.sim$aov$TypeIError)

plan8x14.sim$aov$TrtF <- plan8x14.sim$aov$TrtMS/plan8x14.sim$aov$ResMS
ggplot(plan8x14.sim$aov, aes(TrtF)) + stat_density(geom="line",position="identity",size=1)
```



```{r}
ggplot(plan8x14.sim$aov, aes(ResVar)) + stat_density(geom="line",position="identity",size=1)
```


```{r}
ggplot(plan8x14.sim$aov, aes(RepVar)) + stat_density(geom="line",position="identity",size=1)
plan8x14.sim$aov$RepF <- plan8x14.sim$aov$RepMS/plan8x14.sim$aov$ResMS
subset(plan8x14.sim$aov,plan8x14.sim$aov$RepF<1)
```

