---
title: "Treatment Stability/Trial Dendrogram Simulations"
author: "Peter Claussen"
date: "June 3, 2015"
output: html_document
---

```{r}
library(agricolae)
library(klaR)
```

```{r,echo=FALSE}
transpose.plot <- function(plot.dat,fixed.prop=TRUE) {
  means.matrix <- data.frame(tapply(plot.dat$Value,list(plot.dat$Treatment,plot.dat$Trial),mean))
  means.vector <- tapply(plot.dat$Value,list(plot.dat$Treatment),mean)

  par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
  m.table <- plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2,fixed.prop=fixed.prop
                      )
  par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
  m.hc <- plot.clusters.ARMST(means.matrix, means.vector, xlab='Treatment Mean', ylab='',fixed.prop=fixed.prop)
  par(fig = c(0, 1, 0, 1))
  return(m.table)
}
```

```{r}
fit <- standard.plot(base.dat,fixed.prop=TRUE)
```

```{r}
fit2 <- transpose.plot(base.dat,fixed.prop=FALSE)
```

```{r}
fit2 <- transpose.plot(base.dat,fixed.prop=TRUE)
```

```{r}
library(locfit)
means.vector <- tapply(base.dat$Value,list(base.dat$Trial),mean)
hist(means.vector,probability=TRUE)
lines(density(means.vector),col="blue")
lines(locfit(~ means.vector,alpha=0.8),col="red")
```

```{r}
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
res.fit <- plot.interaction.ARMST(mn.matrix, mn.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1,mark.int=outliers$pairs
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
res.hc <- plot.clusters.ARMST(mn.matrix, mn.vector, xlab='Trial Mean', ylab='Distance')
par(fig = c(0, 1, 0, 1))
```

Alternate decompositions
```{r}
mn.pc <- principal.components(t(mn.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))


REP <- 3
MSerror <- 0.035
model<-AMMI(mn.table$data$TrtNo,mn.table$data$Trial.ID,  REP, mn.table$data$values, MSerror,PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=base.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))

base.dat$a.star = tdf$t1df$a.star[base.dat$Treatment]
base.dat$b.star = tdf$t1df$b.star[base.dat$Trial]

lm3 <- lm(Value ~ Treatment+Trial + Trial:Replicate + a.star:b.star,data=base.dat)
anova(lm3)
fix.reml <- lmer(Value ~ Treatment+Trial + a.star:b.star + (1 | Trial:Replicate),data=base.dat)
VarCorr(fix.reml)
anova(fix.reml)
ran.reml <- lmer(Value ~ Treatment+(1 | Trial) + (1 | a.star:b.star) + (1 | Trial:Replicate),data=base.dat)
VarCorr(ran.reml)
anova(ran.reml)

ammi <- ammi.1df.ARMST(data=base.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2

lm3 <- lm(Value ~ Treatment+Trial + Trial:Replicate + PC1a:PC1b + PC2a:PC2b, data=ammi$data)
anova(lm3)
fix.reml <- lmer(Value ~ Treatment+Trial + PC1a:PC1b + PC2a:PC2b + (1 | Trial:Replicate), data=ammi$data)
VarCorr(fix.reml)
anova(fix.reml)
ran.reml <- lmer(Value ~ Treatment+(1 | Trial) + (1 | PC1a:PC1b) + (1 | PC2a:PC2b) + (1 | Trial:Replicate), data=ammi$data)
VarCorr(ran.reml)
anova(ran.reml)
```

This we use to reproduce the AMMI biplot
```{r}
plot(theta*lambda,theta2*lambda2)
plot(delta*lambda,delta2*lambda2)
```

So our expected values are
```{r}
mean(unlist(decomp$gamma))
sd(unlist(decomp$gamma))
ammi <- (theta %*% t(delta) * lambda)
mean(ammi)
sd(ammi)
ammi.diffs <- decomp$gamma - ammi
ammi.diffs <- unlist(ammi.diffs)
sd(ammi.diffs)
hist(ammi.diffs, prob=TRUE, col="grey")# prob=TRUE for probabilities not counts
lines(density(ammi.diffs), col="blue", lwd=2) # add a density estimate with defaults
lines(density(ammi.diffs, adjust=2), lty="dotted", col="darkgreen", lwd=2) 

ammi2 <- (theta %*% t(delta) * lambda) + (theta2 %*% t(delta2) * lambda2)
mean(ammi2)
sd(ammi2)
ammi2.diffs <- decomp$gamma - ammi2
ammi2.diffs <- unlist(ammi2.diffs)
sd(ammi2.diffs)
hist(ammi2.diffs, prob=TRUE, col="grey")# prob=TRUE for probabilities not counts
lines(density(ammi2.diffs), col="blue", lwd=2) # add a density estimate with defaults
lines(density(ammi2.diffs, adjust=2), lty="dotted", col="darkgreen", lwd=2) 
```

```{r}
outliers <- interaction.outliers(mn.matrix, mn.vector,fixed=TRUE,multiplicative=FALSE)
outliers$outliers
```


```{r,echo=FALSE}
mn.matrix <- data.frame(tapply(base.dat$Value,list(base.dat$Trial,base.dat$Treatment),mean))
mn.matrix
mn.vector <- tapply(base.dat$Value,list(base.dat$Trial),mean)
mn.vector
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
mn.table <- plot.interaction.ARMST(mn.matrix, mn.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2,mark.int=list(c(2,7),c(4,7))
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
mn.hc <- plot.clusters.ARMST(mn.matrix, mn.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))
```


#### Tukey's 1 df

Note, this is the 1-df test for unreplicated observations. The previous fit was based on all observations.

```{r}
tdf <- tukey.1df.ARMST(data=mn.table$data,AName="TrtNo",BName="Trial.ID",response="values")
summary(tdf$lm)
summary(aov(tdf$lm))

ammi <- ammi.1df.ARMST(data=mn.table$data,AName="TrtNo",BName="Trial.ID",response="values")
ammi$pc1
ammi$pc2
```

Compare these to Tukey estimates
```{r}
tdf$a.star
Treatment.effects
tdf$b.star
trial.effects
```


Map these effects base to our base data. I'm using notation from Yan (2006)
```{r}
base.dat$alpha = Treatment.effects[base.dat$Treatment]
base.dat$beta = trial.effects[base.dat$Trial]
base.dat$theta = NA
rows = dim(base.dat)[1]
for(idx in 1:rows) {
  current <- base.dat[idx,]
  base.dat$theta[idx] <- txt.effects[current$Treatment,current$Trial]
}
base.dat$y = base.dat$Value
```

### phia
```{r}
library(phia)
lm2.means <- interactionMeans(lm2)
plot(lm2.means)
testInteractions(lm2, fixed="Treatment", across="Trial")
```

### Bootstrap original

We run a single simulation using the base data and model. I'm doing this to confirm, visually, that my simulation is making sense. I'm modeling this as a model with both treatment and trial fixed.

```{r}
bootstrap.dat <- base.dat
rows = dim(base.dat)[1]

rep.samples <- rnorm(27, mean=0, sd=rep.sd)
names(rep.samples) <- levels(base.dat$Block)
error.samples <- rnorm(rows, mean=0, sd=error.sd)

fix.eff <- grand.mean + bootstrap.dat$alpha + bootstrap.dat$beta + bootstrap.dat$theta
ran.eff <- rep.samples[bootstrap.dat$Block] 
bootstrap.dat$Value <- fix.eff + ran.eff + error.samples

VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r, echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
```

The expected mean squares (after McIntosh) and resulting AOV values from simulation. I'll repeat this table for each simulation, but changing formula as necessary.

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

This should be comparable to the original AOV table above. However, a couple common differences is that Treatment:Trial interaction is sometimes significant, even though we use the original data's fixed interaction terms, which is not significant. Replicate effects are marginally signficant; this varies as well. Treatments and Trials, as expected, have consistently been significant in simulations.

- Having run this script several times, I note frequent differences in the trial dendrogram. The original pattern of 3-4-2 is a common result, but not the only result. (That might be expected, given that interactions are not always significant). We might consider a boot-strapping method to estimate the reliability of the displayed dendrogram, or to find the most parsimonious dendrogram.
 

```{r}
mn.pc <- principal.components(t(fit$table))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(fit$data$TrtNo,fit$data$Trial.ID,  REP, fit$data$values, MSerror,PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(aov(tdf$t1df$lm))
summary(aov(tdf$alt1))
summary(aov(tdf$alt2))

tdf <- alternate.tukey.1df(data=fit$data,AName="TrtNo",BName="Trial.ID",response="values")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))

ammi <- ammi.1df.ARMST(data=fit$data,AName="TrtNo",BName="Trial.ID",response="values")
ammi$pc1
ammi$pc2

ammi <- ammi.1df.ARMST(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2
```









```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment, bootstrap.dat$Trial,  bootstrap.dat$Replicate, bootstrap.dat$Value,PC=TRUE)
plot(model)
plot(model,0,1,type=1)

model<-AMMI(fit$data$TrtNo,fit$data$Trial.ID,  REP, fit$data$values, MSerror,PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(aov(tdf$t1df$lm))
summary(aov(tdf$alt1))
summary(aov(tdf$alt2))

tdf <- alternate.tukey.1df(data=means.table$data,AName="TrtNo",BName="Trial.ID",response="values")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))

ammi <- ammi.1df.ARMST(data=means.table$data,AName="TrtNo",BName="Trial.ID",response="values")
ammi$pc1
ammi$pc2

ammi <- ammi.1df.ARMST(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2
anova(lm(Value ~ Treatment+Trial + Trial:Replicate + PC1a:PC1b + PC2a:PC2b, data=ammi$data))
```



```{r}
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers

mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```

```{r}
ammi <- ammi.1df.ARMST(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2
```


```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```

```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```

```{r}
ammi <- ammi.1df.ARMST(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2
```



```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```

```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```

```{r}
ammi <- ammi.1df.ARMST(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
ammi$pc1
ammi$pc2
```



```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


### Significant treatments effects, significant but randomly distributed trial effects


```{r}
bootstrap.dat <- base.dat
rows = dim(base.dat)[1]
#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
trial.samples <- rnorm(9, mean=0, sd=trial.sd)
#names(rep.samples) <- levels(base.dat$Block)
names(trial.samples) <- levels(base.dat$Trial)

fix.eff <- grand.mean +  Treatment.effects[bootstrap.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.dat$Block] + trial.samples[bootstrap.dat$Trial]
bootstrap.dat$Value <- fix.eff + ran.eff + error.samples
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r,echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 


```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


### Significant treatments effects, randomly distributed trial and txt effects


```{r}
bootstrap.dat <- base.dat
lambda=2
#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#trial.samples <- rnorm(9, mean=0, sd=trial.sd)
txt.samples <- rnorm(36, mean=0, sd=txt.sd)

#names(rep.samples) <- levels(base.dat$Block)
#names(trial.samples) <- levels(base.dat$Trial)
names(txt.samples) <- levels(base.dat$Txt)

fix.eff <- grand.mean +  Treatment.effects[bootstrap.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.dat$Block] + trial.samples[bootstrap.dat$Trial] +lambda*txt.samples[bootstrap.dat$Txt] 
bootstrap.dat$Value <- fix.eff + ran.eff + error.samples
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r,echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 



```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```




```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```



```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```




```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


#### Quadratic fit

```{r,echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
means.matrix <- data.frame(tapply(bootstrap.dat$Value,list(bootstrap.dat$Trial,bootstrap.dat$Treatment),mean))
means.vector <- tapply(bootstrap.dat$Value,list(bootstrap.dat$Trial),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
means.table <- plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2,poly=2
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
means.hc <- plot.clusters.ARMST(means.matrix, means.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))
```


### Fixed treatment and trials, interaction proportional to trial mean (inverse treatment)

```{r}
scale = 0.01
bootstrap.dat <- base.dat

#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#names(rep.samples) <- levels(base.dat$Block)

fix.eff <- grand.mean + Treatment.effects[bootstrap.dat$Treatment] + 
                        trial.effects[bootstrap.dat$Trial] + 
                        scale*trial.effects[bootstrap.dat$Trial]/Treatment.effects[bootstrap.dat$Treatment]
ran.eff <- rep.samples[bootstrap.dat$Block]

bootstrap.dat$Value <- fix.eff + ran.eff + error.samples
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r,echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```


Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```

### Fixed treatment and trials, interaction proportional to trial mean (inverse trial)

```{r}
tscale = 0.02
bootstrap.dat <- base.dat

#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#names(rep.samples) <- levels(base.dat$Block)

fix.eff <- grand.mean + Treatment.effects[bootstrap.dat$Treatment] + 
                        trial.effects[bootstrap.dat$Trial] + 
                        tscale*Treatment.effects[bootstrap.dat$Treatment]/trial.effects[bootstrap.dat$Trial]
ran.eff <- rep.samples[bootstrap.dat$Block]

bootstrap.dat$Value <- fix.eff + ran.eff + error.samples
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r,echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```


Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 


```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


### Fixed treatment, random trials, interaction proportional to trial effect (multiplicative)

```{r}
bootstrap.dat <- base.dat
rows = dim(base.dat)[1]
#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#trial.samples <- rnorm(9, mean=0, sd=trial.sd)

#names(rep.samples) <- levels(base.dat$Block)
#names(trial.samples) <- levels(base.dat$Trial)

fix.eff <- grand.mean + Treatment.effects[bootstrap.dat$Treatment] + 
                        trial.samples[bootstrap.dat$Trial] + 
                        Treatment.effects[bootstrap.dat$Treatment]*trial.samples[bootstrap.dat$Trial]
ran.eff <- rep.samples[bootstrap.dat$Block]

bootstrap.dat$Value <- fix.eff + ran.eff + error.samples

VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r, echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```


Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 


```{r}
mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


### Fixed treatment, random trials, interaction proportional to trial effect (inverse treatment)

```{r}
bootstrap.dat <- base.dat
rows = dim(base.dat)[1]
#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#trial.samples <- rnorm(9, mean=0, sd=trial.sd)

#names(rep.samples) <- levels(base.dat$Block)
#names(trial.samples) <- levels(base.dat$Trial)

fix.eff <- grand.mean + Treatment.effects[bootstrap.dat$Treatment] + 
                        trial.samples[bootstrap.dat$Trial] + 
                        scale*trial.samples[bootstrap.dat$Trial]/Treatment.effects[bootstrap.dat$Treatment]
ran.eff <- rep.samples[bootstrap.dat$Block]

bootstrap.dat$Value <- fix.eff + ran.eff + error.samples
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
```

```{r, echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers
```


Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

## Mixed Models

### Heterogenous treatment variances

```{r}
het.trt.reml <- lmer(Value ~ Treatment + (1 | Trial/Replicate) + (0 + Treatment | Trial),data=base.dat)
het.trt.theta <- VarCorr(het.trt.reml)
het.trt.theta
library(blme)
var.blmer <- blmer(Value ~ Treatment + (1 | Trial/Replicate) + (0 + Treatment | Trial), data=base.dat)
VarCorr(var.blmer)
tapply(bootstrap.dat$Value,list(base.dat$Treatment),sd)
```

```{r}
bootstrap.dat <- base.dat
bootstrap.dat$Block <- bootstrap.dat$Trial:bootstrap.dat$Replicate
#rep.samples <- rnorm(27, mean=0, sd=rep.sd)
#trial.samples <- rnorm(9, mean=0, sd=trial.sd)
txt.samples <- c(rnorm(9, mean=0, sd=0.4),rnorm(9, mean=0, sd=0.01),
                rnorm(9, mean=0, sd=0.4),rnorm(9, mean=0, sd=0.01))

#names(rep.samples) <- levels(base.dat$Block)
#names(trial.samples) <- levels(base.dat$Trial)
names(txt.samples) <- levels(base.dat$Txt)

fix.eff <- grand.mean +  Treatment.effects[bootstrap.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.dat$Block] + trial.samples[bootstrap.dat$Trial] + txt.samples[bootstrap.dat$Txt] 
bootstrap.dat$Value <- fix.eff + ran.eff + error.samples

VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=bootstrap.dat))
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (Treatment | Trial),data=bootstrap.dat))
VarCorr(lmer(Value ~ Treatment + (1 | Block) + (0 + Treatment | Trial),data=bootstrap.dat))
VarCorr(lmer(Value ~ Treatment + (1 | Trial/Replicate) + (0 + Treatment | Trial),data=bootstrap.dat))
VarCorr(lmer(Value ~ Treatment + (0 + Treatment | Trial),data=bootstrap.dat))
var.blmer <- blmer(Value ~ Treatment + (1 | Trial/Replicate) + (0 + Treatment | Trial), data=bootstrap.dat)
VarCorr(var.blmer)

library(MCMCglmm)
var.mcmc1 <- MCMCglmm(fixed=Value ~ Treatment, random = ~ Trial + idh(Treatment):Trial + Trial:Replicate, data=bootstrap.dat, verbose=FALSE)
summary(var.mcmc1)

tapply(bootstrap.dat$Value,list(bootstrap.dat$Treatment),sd)

tapply(txt.samples[bootstrap.dat$Txt],list(bootstrap.dat$Treatment),sd)
tapply(txt.samples[bootstrap.dat$Txt],list(bootstrap.dat$Treatment),mean)

```


library(nlme)
#fit <- lme(Y ~ time, random=list(year=~1, date=~time), data=X, weights=varIdent(form=~1|year))
fit <- lme(Value ~ Treatment, random=list(Trial=~Treatment), data=bootstrap.dat)
fit
#lme(y ~ f - 1, random = list(g = pdDiag(~f)), data = d)
lme(Value ~ Treatment, random = list(Trial = pdDiag(~Treatment)), data = bootstrap.dat)


```{r, echo=FALSE}
aov.tbl <- anova(lm(Value ~ Treatment*Trial + Trial:Replicate,data=bootstrap.dat))
```

```{r}
fit <- standard.plot(bootstrap.dat)
fit$fit
```

We can't run this model:
```{r}
means.table$data$TrtNo <- as.factor(means.table$data$TrtNo)
means.table$data$Trial.ID <- as.factor(means.table$data$Trial.ID)
library(nlme)
lme1 <- gls(values ~ TrtNo, data=means.table$data,
  weight=varIdent(form = ~ 1 | TrtNo))
summary(lme1)
(lme1$sigma*
      coef(lme1$modelStruct$varStruct,
          uncons = FALSE, allCoef = TRUE))^2
var.mcmc1 <- MCMCglmm(fixed=values ~ TrtNo, rcov = ~ idh(TrtNo):units, data=means.table$data, verbose=FALSE)
summary(var.mcmc1)
gls(values ~ TrtNo, data=means.table$data,
  weight=varIdent(form = ~ Trial.ID | TrtNo))
gls(values ~ TrtNo, data=means.table$data,
  corr=varIdent(, form = ~ Trial.ID | TrtNo))
#lmer(values ~ (0 + TrtNo | 1), data=means.table$data)
#lmer(values ~ (TrtNo | Trial.ID), data=means.table$data)
```


Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \sigma^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \sigma^2_{TL}$             | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 


```{r}
outliers <- interaction.outliers(means.matrix, means.vector,fixed=FALSE)
outliers$outliers
outliers <- interaction.outliers(means.matrix, means.vector,fixed=TRUE)
outliers$outliers

mn.pc <- principal.components(t(means.matrix))
par(mfrow=c(1,2))
biplot(mn.pc$P3,main="P3")
biplot(mn.pc$P5,main="P5")
par(mfrow=c(1,1))

model<-AMMI(bootstrap.dat$Treatment,bootstrap.dat$Trial,bootstrap.dat$Replicate, bootstrap.dat$Value, PC=TRUE)
plot(model)
plot(model,0,1,type=1)

tdf <- alternate.tukey.1df(data=bootstrap.dat,AName="Treatment",BName="Trial",response="Value")
summary(tdf$t1df$lm)
summary(aov(tdf$t1df$lm))
summary(tdf$alt1)
summary(aov(tdf$alt1))
summary(tdf$alt2)
summary(aov(tdf$alt2))
```


### Heterogenous replicate variances

```{r}
het.rep.reml <- lmer(Value ~ Treatment + (Trial | Replicate) + (Treatment : Trial),data=base.dat)
het.rep.theta <- VarCorr(het.rep.reml)
het.rep.theta
```

### Heterogeneous trial variances

```{r}
het.loc.reml <- lmer(Value ~ Trial + (1 | Trial:Replicate) + (Trial | Treatment),data=base.dat)
het.loc.theta <- VarCorr(het.loc.reml)
het.loc.theta
```

### Heterogeneous error variances by trial

### AMMI model
$$y_ij = \mu + \tau_i + \delta_j + \Sigma _{k=1}^t \lambda_{k} \alpha _{ik} + \gamma _{jk} + e_{ij}$$

where $t = min(g-1,e-1)$ (from Yang)

We get $\lambda, \alpha$ and $\gamma$ by SVD of the genotype x location matrix, 
$$P_{m,n} = G_{m,r} L_{r,r}E^T_{n,r}, r \le min(m,n)$$ (Yan)
where $P$ is an $m$ genotype by $n$ environment table of means.

```{r}
svd.matrix <- tapply(base.dat$Value,list(base.dat$Treatment,base.dat$Trial),mean)
svd.base <- svd(svd.matrix)
svd.base
```

SVD is commonly stated in the terms $M = U \Sigma V^{\ast}$, with the diagonal element sof $\Sigma$ the singular values; thus, the results from R, `d = diag(Sigma)`



### GGE Biplot model
$$P_{ij} = (y_{ij} - \mu - \beta_{j})/s_j = (\alpha_i + \theta _{ij})/s_j$$
 where $s_j$ may be the standard deviation or standard error of column $j$
 
```{r}
lhs = base.dat$y - grand.mean - base.dat$beta
rhs = base.dat$alpha + base.dat$theta
plot(lhs,rhs)
lm(lhs ~ rhs)
```



Todo
* Plot error bars
 - this will show differences in (heterogenous) treatment or replicate variances.
* Fit lines using generalized least squares, using covariances.
Broad vs Narrow sense heritability
Stability Parameters

AMMI
----

```{r}
model<- AMMI(base.dat$Trial, base.dat$Treatment, base.dat$Replicate, base.dat$Value)
model$ANOVA
plot(model)
```


```{r}
plot(model, first=0,second=1, number=TRUE)
```


```{r}
outliers <- interaction.outliers(mn.matrix, mn.vector,fixed=TRUE)
outliers$outliers
```
```{r}
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
res.fit <- plot.interaction.ARMST(mn.matrix, mn.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1,mark.int=outliers$pairs
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
res.hc <- plot.clusters.ARMST(mn.matrix, mn.vector, xlab='Trial Mean', ylab='Distance',
                              plot.names=names(mn.vector))
par(fig = c(0, 1, 0, 1))
```

```{r}
REP <- 3
MSerror <- 0.03458
#This fails
#model<-AMMI(means.table$data$Trial.ID,means.table$data$TrtNo, REP, means.table$data$values, MSerror,PC=TRUE)
model<-AMMI(means.table$data$TrtNo,means.table$data$Trial.ID,  REP, means.table$data$values, MSerror,PC=TRUE)
plot(model)
print(model$ANOVA,na.print = "")
# Biplot with the one restored observed.
plot(model,0,1,type=1)
```

```{r}
#fails
#model<- AMMI(base.dat$Trial, base.dat$Treatment, base.dat$Replicate, base.dat$Value,PC=TRUE)
model<- AMMI(base.dat$Treatment, base.dat$Trial,  base.dat$Replicate, base.dat$Value,PC=TRUE)
# with principal components model$PC is class "princomp" 
pc<- model$PC
pc$loadings
summary(pc)
biplot(pc)
# Principal components by means of the covariance similar AMMI
# It is to compare results with AMMI
cova<-cov(model$genXenv)
values<-eigen(cova)
total<-sum(values$values)
round(values$values*100/total,2)
```




Marginal histograms (from layout help)
x <- pmin(3, pmax(-3, stats::rnorm(50)))
y <- pmin(3, pmax(-3, stats::rnorm(50)))
xhist <- hist(x, breaks = seq(-3,3,0.5), plot = FALSE)
yhist <- hist(y, breaks = seq(-3,3,0.5), plot = FALSE)
top <- max(c(xhist$counts, yhist$counts))
xrange <- c(-3, 3)
yrange <- c(-3, 3)
nf <- layout(matrix(c(2,0,1,3),2,2,byrow = TRUE), c(3,1), c(1,3), TRUE)
layout.show(nf)

par(mar = c(3,3,1,1))
plot(x, y, xlim = xrange, ylim = yrange, xlab = "", ylab = "")
par(mar = c(0,3,1,1))
barplot(xhist$counts, axes = FALSE, ylim = c(0, top), space = 0)
par(mar = c(3,0,1,1))
barplot(yhist$counts, axes = FALSE, xlim = c(0, top), space = 0, horiz = TRUE)


References
vargas.m-02-2015 - Show linear and cubic interactions.
crossa.j-02-2015 - Other models for interactions
brown.k-09-1983
lin 1986
yang-2002
Moll et al. (1978) used an approach similar
to those of Robertson (1959) and Cockerham (1963) to partition the interaction sum of squares into two components, one due to heterogeneity of genetic variances across environments and the other due to imperfect genetic correlations of the same trait measured in different environments. Muir et al. (1992) further showed that the partitioning could be made with reference to either genotypes or environments

Joint Regression vs AMMI (Annichiario)

Linear and bilinear models for the analysis of multi-environment trials: I. An inventory of models
Some vocabulary and grammar for the analysis of multi-environment trials, as applied to the analysis of FPB and PPB trials

From Yang 2009

"If the effect levels reasonably represent a probability distribution, then the effect is random; if, on the other hand, they do not represent a probability distribution, then the effect is fixed."
He then cites Henderson (1984) and the factor analytic model.

Mandel's row-linear model (Non-Additivity in Two-Way Analysis of Variance)

Tai's stability plot