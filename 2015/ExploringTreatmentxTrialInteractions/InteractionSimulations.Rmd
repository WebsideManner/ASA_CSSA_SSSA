---
title: "Treatment Stability/Trial Dendrogram Simulations"
author: "Peter Claussen"
date: "June 3, 2015"
output: html_document
---

We'll assume for this analysis a data set `base.dat` with columns `Treatment, Trial, Replicate` and `Value`. We can the easily swap different data sets into this analysis by creating the appropriate data from. 

Let's start with a standard data set - SAS multilocation.

```{r}
set.seed(1992)
library(ARMR)

library(SASmixed)
data(Multilocation)
base.dat <- data.frame(
  Treatment = Multilocation$Trt,
  Trial = Multilocation$Location,
  Replicate = Multilocation$Block,
  Value = Multilocation$Adj)
base.dat$Txt <- base.dat$Treatment:base.dat$Trial
base.dat$Block <- base.dat$Trial:base.dat$Replicate
```

```{r}
source("../../ARMR.git/ARMR/R/plot.interaction.ARMST.R")
#library(lsmeans)
library(lme4)
```


We plot the original data (hiding the code)


```{r,echo=FALSE}
mn.matrix <- data.frame(tapply(base.dat$Value,list(base.dat$Trial,base.dat$Treatment),mean))
mn.matrix
mn.vector <- tapply(base.dat$Value,list(base.dat$Trial),mean)
mn.vector
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
mn.table <- plot.interaction.ARMST(mn.matrix, mn.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
mn.hc <- plot.clusters.ARMST(mn.matrix, mn.vector, xlab='Trial Mean', ylab='',
                             cld=c("cd","a","cd","ab","bc","d","bc","d","ab"))
par(fig = c(0, 1, 0, 1))
```

```{r}
fit <- standard.plot(base.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


For simulation, we will use parameters estimated from the original data. Since these are balanced data, we could use AOV estimates, but I'll put code in for REML estimates.

```{r}
lm2 <- lm(Value ~ Treatment*Trial + Trial:Replicate,data=base.dat)
anova(lm2)
library(lme4)
fix.reml <- lmer(Value ~ Treatment*Trial + (1 | Trial:Replicate),data=base.dat)
VarCorr(fix.reml)
mix.reml <- lmer(Value ~ Treatment + (1 | Trial/Replicate) + (1 | Trial:Treatment),data=base.dat)
theta <- VarCorr(mix.reml)
theta

library(lsmeans)
lsmeans(fix.reml,cld ~ Treatment)
lsmeans(fix.reml,cld ~ Trial)
lsmeans(mix.reml,cld ~ Treatment)
```

This part is sensitive, I think. The interface to these attributes have changed in the past.
```{r}
error.sd <- attr(theta, "sc")
error.sd 
rep.sd <- attr(theta[[2]],"stddev")
rep.sd
trial.sd <- attr(theta[[3]],"stddev")
trial.sd
txt.sd <- attr(theta[[1]],"stddev")
txt.sd
```



If fixed and multiplicative, we assume an AMMI type interaction model. To do this, we decompose the interactions matrix, assuming the notation

$$
\gamma _{ij} = \lambda \theta _i \delta _j + \epsilon _{ij}
$$

and we assume $\epsilon _{ij} \sim N(0,\sigma^2 _{\gamma})$

```{r}
decomp <- decompose.means.table(data.frame(mn.matrix))
svd.gamma <- svd(decomp$gamma)
lambda <- sqrt(diag(svd.gamma$d))[1]
theta = svd.gamma$u[,1]
delta = svd.gamma$v[,1]
```

If we want the first two components, then
```{r}
theta2 = svd.gamma$u[,2]
delta2 = svd.gamma$v[,2]
lambda2 = sqrt(svd.gamma$d)[2]
```

### MCMC Estimates
```{r}
library(MCMCglmm)
var.mcmc1 <- MCMCglmm(fixed=Value ~ Treatment, random = ~ Trial + Treatment:Trial + Trial:Replicate, data=base.dat, verbose=FALSE)
summary(var.mcmc1)
```

I'm going to be lazy here and compute effects from means. This is okay as long as we have balanced data.
```{r}
grand.mean <- mean(base.dat$Value)
Treatment.effects <- tapply(base.dat$Value,list(base.dat$Treatment),mean) - grand.mean
trial.effects <- tapply(base.dat$Value,list(base.dat$Trial),mean) - grand.mean
rep.effects <- tapply(base.dat$Value,list(base.dat$Block),mean) - grand.mean

cell.means <- tapply(base.dat$Value,list(base.dat$Treatment,base.dat$Trial),mean)
Treatment.matrix <- matrix(rep(Treatment.effects,9),nrow=4)
trial.matrix <- matrix(rep(trial.effects,4),nrow=4,byrow=TRUE)
txt.effects <- cell.means-(Treatment.matrix+trial.matrix+grand.mean)
```

```{r}
library(gridExtra)
s.matrix <- sorted.matrix(t(mn.matrix))
decomp <- decompose.means.table(data.frame(s.matrix))
grid.arrange(arrangeGrob(ggplot.matrix(data.frame(s.matrix)),
             ggplot.matrix(data.frame(decomp$alpha)),
             ggplot.matrix(data.frame(decomp$beta)),
             ggplot.matrix(decomp$gamma),
             ncol=2))
```


Random Trial Simulations
-------------------------
### Bootstrap original (R0)

```{r}
bootstrap.r0.dat <- base.dat
lambda=1

rows = dim(base.dat)[1]

rep.samples <- rnorm(27, mean=0, sd=rep.sd)
names(rep.samples) <- levels(base.dat$Block)

trial.samples <- rnorm(9, mean=0, sd=trial.sd)
names(trial.samples) <- levels(base.dat$Trial)

txt.samples <- rnorm(36, mean=0, sd=txt.sd)
names(txt.samples) <- levels(base.dat$Txt)

error.samples <- rnorm(rows, mean=0, sd=error.sd)

fix.eff <- grand.mean + Treatment.effects[bootstrap.r0.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r0.dat$Block] + trial.samples[bootstrap.r0.dat$Trial] + lambda*txt.samples[bootstrap.r0.dat$Txt] 

bootstrap.r0.dat$Value <- fix.eff + ran.eff + error.samples

sim.theta <- c(0,-0.4,0.4,-0.8,0,0,0,0.4,0)
names(sim.theta) <- names(trial.samples)
sim.delta <- c(0.8, 0.0, 0.0,-0.8)
names(sim.delta) <- names(Treatment.effects)
```

```{r}
fit <- standard.plot(bootstrap.r0.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


### No significant treatment or trial effects
```{r}
bootstrap.r1.dat <- bootstrap.r0.dat
fix.eff <- grand.mean
ran.eff <- rep.samples[bootstrap.r1.dat$Block]
bootstrap.r1.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r1.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Only significant trials
```{r}
bootstrap.r2.dat <- bootstrap.r0.dat
fix.eff <- grand.mean
ran.eff <- rep.samples[bootstrap.r2.dat$Block] + trial.samples[bootstrap.r2.dat$Trial]
bootstrap.r2.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r2.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, non-significant interaction

$$\tau_1 \ne \tau_2 \ne \dots \ne \tau_m = 0$$
$$t ~ N(0, \sigma^2_L)$$
$$\theta^2_T \ne 0,  \sigma^2_{TL} = 0$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$


```{r}
bootstrap.r3.dat <- bootstrap.r0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.r3.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r3.dat$Block] + trial.samples[bootstrap.r3.dat$Trial]
bootstrap.r3.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r3.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, significant random interaction

$$\tau_1 \ne \tau_2 \ne \dots \ne \tau_m = 0$$
$$t ~ N(0, \sigma^2_L)$$
$$\theta^2_T \ne 0,  \sigma^2_{TL} > 0$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$


```{r}
bootstrap.r4.dat <- bootstrap.r0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.r4.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r4.dat$Block] + trial.samples[bootstrap.r4.dat$Trial] + 3*txt.samples[bootstrap.r4.dat$Txt] 
bootstrap.r4.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r4.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

The last graph does not appear different from the original. What is the nature of the treatment by trial interaction in this data? Is there a systematic (fixed) effect of treatment by trial interaction, or is the treatment by trial term simply drawn from a single random population?

We consider the histogram for treatment by trial interaction.
```{r}
library(MASS)
truehist(txt.effects)
truehist(txt.effects,nbins=18)

hist(txt.effects, prob=TRUE, col="grey")# prob=TRUE for probabilities not counts
lines(density(txt.effects), col="blue", lwd=2) # add a density estimate with defaults
lines(density(txt.effects, adjust=2), lty="dotted", col="darkgreen", lwd=2) 
```

Since interaction is significant, visualize
```{r}
fit <- standard.plot(bootstrap.r4.dat,dual.dendrogram=TRUE)
```

### Significant treatments and trials, synergistic interaction
```{r}
bootstrap.r5.dat <- bootstrap.r0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.r5.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r5.dat$Block] + trial.samples[bootstrap.r5.dat$Trial] + 2*Treatment.effects[bootstrap.r5.dat$Treatment]*trial.samples[bootstrap.r5.dat$Trial]
bootstrap.r5.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r5.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

Note that this maintains dendrogram

```{r}
fit <- standard.plot(bootstrap.r5.dat,dual.dendrogram=TRUE)
```

### Significant treatments and trials, antagonistic interaction
```{r}
bootstrap.r6.dat <- bootstrap.r0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.r6.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r6.dat$Block] + trial.samples[bootstrap.r6.dat$Trial] - 2*Treatment.effects[bootstrap.r5.dat$Treatment]*trial.samples[bootstrap.r5.dat$Trial]
bootstrap.r6.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r6.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, heterogenous slopes interaction
```{r}
bootstrap.r7.dat <- bootstrap.r0.dat
bootstrap.r7.dat$l <- 0
bootstrap.r7.dat$l[bootstrap.r7.dat$Treatment==1] <- 0.5
bootstrap.r7.dat$l[bootstrap.r7.dat$Treatment==2] <- -0.5
fix.eff <- grand.mean + Treatment.effects[bootstrap.r7.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r7.dat$Block] + trial.samples[bootstrap.r7.dat$Trial] + trial.samples[bootstrap.r7.dat$Trial]*bootstrap.r7.dat$l

bootstrap.r7.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r7.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, AMMI
```{r}
bootstrap.r8.dat <- bootstrap.r0.dat
bootstrap.r8.dat$theta <- sim.theta[bootstrap.r8.dat$Trial]
bootstrap.r8.dat$delta <- sim.delta[bootstrap.r8.dat$Treatment]

fix.eff <- grand.mean + Treatment.effects[bootstrap.r8.dat$Treatment] 
ran.eff <- rep.samples[bootstrap.r8.dat$Block] + trial.samples[bootstrap.r8.dat$Trial] + bootstrap.r8.dat$theta*bootstrap.r8.dat$delta
bootstrap.r8.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r8.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

```{r}
library(agricolae)
ammi.dat <- fit$data
rownames(fit$table) <- paste("E",1:9,sep="")
colnames(fit$table) <- paste("T",1:4,sep="")
ammi.dat$ENV <- as.factor(rownames(fit$table)[as.numeric(ammi.dat$Trial.ID)])
ammi.dat$GEN <- as.factor(colnames(fit$table)[as.numeric(ammi.dat$TrtNo)])
REP <- 3
MSerror <- 1
model<-AMMI(ammi.dat$ENV, ammi.dat$GEN, REP, ammi.dat$values, MSerror)
```

```{r}
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
gy.biplot1 <- plot.interaction.ARMST(fit$table, fit$vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
  plot(model, first=0,second=1)
par(fig = c(0, 1, 0, 1))
```

```{r}
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
gy.biplot2 <- plot.interaction.ARMST(fit$table, fit$vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 1
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
  plot(model, first=1,second=2)
par(fig = c(0, 1, 0, 1))
```

### Fixed treatment and trials, interaction proportional to trial mean (quadratic trial)

```{r}
a=1
b=0.4
bootstrap.r9.dat <- bootstrap.r0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.r9.dat$Treatment]
ran.eff <- rep.samples[bootstrap.r9.dat$Block] + trial.samples[bootstrap.r9.dat$Trial] +  
           Treatment.effects[bootstrap.r9.dat$Treatment]*trial.samples[bootstrap.r9.dat$Trial] + 
           b*Treatment.effects[bootstrap.r9.dat$Treatment]*trial.samples[bootstrap.r9.dat$Trial]*trial.samples[bootstrap.r9.dat$Trial]
bootstrap.r9.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.r9.dat)
aov.tbl <- fit$aov
```
Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


#### Quadratic fit

```{r,echo=FALSE}
means.matrix <- data.frame(tapply(bootstrap.r9.dat$Value,list(bootstrap.r9.dat$Trial,bootstrap.r9.dat$Treatment),mean))
means.vector <- tapply(bootstrap.r9.dat$Value,list(bootstrap.r9.dat$Trial),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
means.table <- plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2,poly=2
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
means.hc <- plot.clusters.ARMST(means.matrix, means.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))
```

Fixed Trial Simulations
------------------------

```{r}
var.mcmc2 <- MCMCglmm(fixed=Value ~ Treatment + Trial + 0 + Treatment:Trial, random = ~ Trial:Replicate, data=base.dat, verbose=FALSE)
summary(var.mcmc2)
````

```{r}
bootstrap.f0.dat <- base.dat
lambda=1

rows = dim(base.dat)[1]

fix.eff <- grand.mean + Treatment.effects[bootstrap.r0.dat$Treatment] + trial.effects[bootstrap.f0.dat$Trial] + lambda*txt.effects[bootstrap.f0.dat$Txt] 
ran.eff <- rep.samples[bootstrap.r0.dat$Block] 

bootstrap.f0.dat$Value <- fix.eff + ran.eff + error.samples
```


### No Significant effects

This simulation would be equivalent to a uniformity trial - one genotype planted in one location, blocked in such a way as to have no block effects. Thus

$$\tau_1 = \tau_2 = \dots = \tau_m = 0$$
$$t_1 = t_2 = \dots = t_n = 0$$
$$\theta^2_L = \sigma^2_{R(L)} = \theta^2_T = \theta^2_{TL}$$
$$\sigma^2 > 0$$

```{r}
bootstrap.f1.dat <- bootstrap.f0.dat
fix.eff <- grand.mean + 0
ran.eff <- 0
bootstrap.f1.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f1.dat)
aov.tbl <- fit$aov
```

This is a messy plot. There is not relationship between the rankings of trials based on trial means and the ranking based on treatments with trials. This is expected since there are no treatment or trial effects. Treatment means are scattered uniformly throughout the treatment stability plot, since there is no real treatment or treatment in trial effect. These observations should be supported by the corresponding AOV table.

There are some cases were the lines fit to treatment means seem to diverge, but we should note that the deviations of treatment means from these lines tends to be greater than the slopes of the lines themselves.

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Only replicates non-zero

$$\tau_1 = \tau_2 = \dots = \tau_m = 0$$
$$t_1 = t_2 = \dots = t_n = 0$$
$$\theta^2_L = \theta^2_T = \theta^2_{TL}$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$

Next we simulate the case were treatment and trials have no effect, but there is variance due to blocks in trials. We randomly sample (with this a each following simulation) a new set of replicate effects based on the estimated variance from the original data.  We assume there is a single population of blocks, distributed 3 at a time to 9 individual trials for a total of 26 blocks. We simulate this by drawing from a random distribution 27 times and assume the block effect, once drawn, is fixed for all plots in that block.

```{r}
bootstrap.f2.dat <- bootstrap.f0.dat

fix.eff <- grand.mean
ran.eff <- rep.samples[bootstrap.f2.dat$Block] 
bootstrap.f2.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f2.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


We shouldn't expect to see any difference between this plot and the previous case with no replicate effects. Cell means are used to produce treatment and trial data points, and since this is balanced data these will average out. 

* The next iteration of this graph may include error bars to illustrate the error of point estimates of treatment in trial means, which includes replicate error. This will help evaluating "which won where"
* We should use mixed model or GLS estimates for treatment by trial points - this will incorporate the variance-covariance matrix and weight point estimates according to replicate and residual errors.


Examination with ANOVA will tell us if estimates of block variance is signficant.

### Significant trial effects, non-significant treatments and interaction

$$\tau_1 = \tau_2 = \dots = \tau_m = 0$$
$$t_1 \ne t_2 \ne \dots \ne t_n$$
$$\theta^2_L = \theta^2_T = \theta^2_{TL}$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$

We use the fixed treatment effects estimated from the original data, and continue to draw from random distributions for replicate and error variances.

```{r}
bootstrap.f2.dat <- bootstrap.f0.dat
fix.eff <- grand.mean +  trial.effects[bootstrap.f2.dat$Trial]
ran.eff <- rep.samples[bootstrap.f2.dat$Block]
bootstrap.f2.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f2.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

Visually, the combination of non-significant treatments and signficant trials typically produces a set of nearly parallel lines that clearly slope upward, left to right, but are not greatly seperated. The significance of trials produces the slopes; while the lack of difference in means implies that all lines fit to treatment means individually would be identical to single line fit to all treatment in trial : trial mean pairs.

In the abscence of treatment effects, the trial dendrogram should be comparable to groupings based strictly on trial means; treatments induce no difference in Euclidean distances among trials, outside random variation.

### Significant treatments effects, non-significant trial

$$\tau_1 \ne \tau_2 \ne \dots \ne \tau_m = 0$$
$$t_1 = t_2 = \dots = t_n$$
$$\theta^2_L = \theta^2_T = \theta^2_{TL}$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$

Next, we assume fixed treatment effects (estimated for the original data). We also sample from replicate and error variances. We hold trial effects to be 0.


```{r}
bootstrap.f3.dat <- bootstrap.f0.dat
fix.eff <- grand.mean +  Treatment.effects[bootstrap.f3.dat$Treatment]
ran.eff <- rep.samples[bootstrap.f3.dat$Block] 
bootstrap.f3.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f3.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


The best indicator of treatment effects is the displacement of lines fit to means. These lines should be displace at the center of the plot, since trials are randomly drawn from a population with a mean of 0, and the slopes of lines arise from random errors about means that, when grouped by means, may or may not be have a mean of zero.

Thus, in some simulations we may see significance for treatment effects (from confounding with replicates in trial). However, note that this simulation uses the default R aov error. In practice, assuming trial significance is tested against replicate in trial MS, and treatment means may be tested against the iteraction mean squares, depending on choice of model.

### Significant treatment and trials, interaction non-significant

$$\tau_1 \ne \tau_2 \ne \dots \ne \tau_m = 0$$
$$t_1 \ne t_2 \ne \dots \ne t_n$$
$$\theta^2_L \ne \theta^2_T \ne 0,  \theta^2_{TL} = 0$$
$$\sigma^2 > 0, \sigma^2_{R(L)}>0$$


```{r}
bootstrap.f4.dat <- bootstrap.f0.dat
fix.eff <- grand.mean +  Treatment.effects[bootstrap.f4.dat$Treatment] + trial.effects[bootstrap.f4.dat$Trial]
ran.eff <- rep.samples[bootstrap.f4.dat$Block]
bootstrap.f4.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f4.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


### Fixed treatment and trials, interaction synergistic

```{r}
bootstrap.f5.dat <- bootstrap.f0.dat
fix.eff <- grand.mean +  Treatment.effects[bootstrap.f5.dat$Treatment] + trial.effects[bootstrap.f5.dat$Trial] + 2*Treatment.effects[bootstrap.f5.dat$Treatment]*trial.effects[bootstrap.f5.dat$Trial]
ran.eff <- rep.samples[bootstrap.f5.dat$Block]
bootstrap.f5.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f5.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Fixed treatment and trials, interaction antagonistic

```{r}
bootstrap.f6.dat <- bootstrap.f0.dat
fix.eff <- grand.mean +  Treatment.effects[bootstrap.f6.dat$Treatment] + trial.effects[bootstrap.f6.dat$Trial] -2*Treatment.effects[bootstrap.f6.dat$Treatment]*trial.effects[bootstrap.f6.dat$Trial]
ran.eff <- rep.samples[bootstrap.f6.dat$Block]
bootstrap.f6.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f6.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, heterogenous slopes interaction
```{r}
bootstrap.f7.dat <- bootstrap.f0.dat
bootstrap.f7.dat$l <- 0
bootstrap.f7.dat$l[bootstrap.f7.dat$Treatment==1] <- 0.5
bootstrap.f7.dat$l[bootstrap.f7.dat$Treatment==2] <- -0.5
fix.eff <- grand.mean + Treatment.effects[bootstrap.f7.dat$Treatment] + trial.effects[bootstrap.f7.dat$Trial] + trial.samples[bootstrap.f7.dat$Trial]*bootstrap.f7.dat$l
ran.eff <- rep.samples[bootstrap.f7.dat$Block]

bootstrap.f7.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f7.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Significant treatments and trials, AMMI
```{r}
bootstrap.f8.dat <- bootstrap.f0.dat
bootstrap.f8.dat$theta <- sim.theta[bootstrap.f8.dat$Trial]
bootstrap.f8.dat$delta <- sim.delta[bootstrap.f8.dat$Treatment]

fix.eff <- grand.mean + Treatment.effects[bootstrap.f8.dat$Treatment] + trial.effects[bootstrap.f8.dat$Trial] + bootstrap.f8.dat$theta*bootstrap.f8.dat$delta
ran.eff <- rep.samples[bootstrap.f8.dat$Block] 
bootstrap.f8.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f8.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```

### Fixed treatment and trials, interaction proportional to trial mean (quadratic trial)

```{r}
a=1
b=0.4
bootstrap.f9.dat <- bootstrap.f0.dat
fix.eff <- grand.mean + Treatment.effects[bootstrap.f9.dat$Treatment] + 
                        trial.effects[bootstrap.f9.dat$Trial] + 
                        Treatment.effects[bootstrap.f9.dat$Treatment]*trial.effects[bootstrap.f9.dat$Trial] + 
                        b*Treatment.effects[bootstrap.f9.dat$Treatment]*trial.effects[bootstrap.f9.dat$Trial]*trial.effects[bootstrap.f9.dat$Trial]
ran.eff <- rep.samples[bootstrap.f9.dat$Block]
bootstrap.f9.dat$Value <- fix.eff + ran.eff + error.samples
fit <- standard.plot(bootstrap.f9.dat)
aov.tbl <- fit$aov
```

Source          | DF    | Expected MS                                    | AOV MS  | F value | Pr (F)
----------------|-------|------------------------------------------------|---------|---------|----
Trial           | $l-1$ | $\sigma^2 + t \sigma^2_{R(L)} + r t \theta^2_L$ | `r aov.tbl[2,3]` | `r aov.tbl[2,4]` | `r aov.tbl[2,5]`
Trial:Replicate     | $r l-1$ | $\sigma^2 + t \sigma^2_{R(L)}$                | `r aov.tbl[4,3]` | `r aov.tbl[4,4]` | `r aov.tbl[4,5]`
Treatment       | $t-1$ | $\sigma^2 + r l \theta^2_T$                     | `r aov.tbl[1,3]` | `r aov.tbl[1,4]` | `r aov.tbl[1,5]`
Treatment:Trial | $(r-1)(t-1)$ | $\sigma^2 + r \theta^2_{TL}$               | `r aov.tbl[3,3]` | `r aov.tbl[3,4]` | `r aov.tbl[3,5]`
Residual        | $l(r-1)(t-1)$ | $\sigma^2$                              | `r aov.tbl[5,3]` |  | 

```{r}
print.stdplot(fit)
```


#### Quadratic fit

```{r,echo=FALSE}
means.matrix <- data.frame(tapply(bootstrap.f9.dat$Value,list(bootstrap.f9.dat$Trial,bootstrap.f9.dat$Treatment),mean))
means.vector <- tapply(bootstrap.f9.dat$Value,list(bootstrap.f9.dat$Trial),mean)
par(fig = c(0, 1, 0.4, 1), mar = (c(1, 4, 1, 1) + 0.1))
means.table <- plot.interaction.ARMST(means.matrix, means.vector, ylab='Treatment in Trial Mean',
                      regression=TRUE, main='Yield', show.legend=TRUE,legend.pos=c(.01,.98),
                      legend.columns=4,lwd = 2,poly=2
                      )
par(fig=c(0,1,0,.4),mar=(c(5, 4, 0, 1) + 0.1), new=TRUE)
means.hc <- plot.clusters.ARMST(means.matrix, means.vector, xlab='Trial Mean', ylab='')
par(fig = c(0, 1, 0, 1))
```

